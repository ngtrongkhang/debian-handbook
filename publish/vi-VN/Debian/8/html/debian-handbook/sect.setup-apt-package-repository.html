<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>15.3. Creating a Package Repository for APT</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Backport, Rebuild, Source package, Archive, Meta-package, Debian Developer, Maintainer"/><link rel="prev" href="sect.building-first-package.html" title="15.2. Building your First Package"/><link rel="next" href="sect.becoming-package-maintainer.html" title="15.4. Becoming a Package Maintainer"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.setup-apt-package-repository.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.building-first-package.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.becoming-package-maintainer.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section class="section" id="sect.setup-apt-package-repository"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.setup-apt-package-repository"/>15.3. Creating a Package Repository for APT</h2></div></div></div>
		
		 <a id="id-1.18.6.2" class="indexterm"></a>
		 <a id="id-1.18.6.3" class="indexterm"></a>
		 <p>
			Falcot Corp gradually started maintaining a number of Debian packages either locally modified from existing packages or created from scratch to distribute internal data and programs.
		</p>
		 <p>
			To make deployment easier, they want to integrate these packages in a package archive that can be directly used by APT. For obvious maintenance reasons, they wish to separate internal packages from locally-rebuilt packages. The goal is for the matching entries in a <code class="filename">/etc/apt/sources.list.d/falcot.list</code> file to be as follows:
		</p>
		 
<pre class="programlisting">
deb http://packages.falcot.com/ updates/
deb http://packages.falcot.com/ internal/
</pre>
		 <a id="id-1.18.6.7" class="indexterm"></a>
		 <p>
			The administrators therefore configure a virtual host on their internal HTTP server, with <code class="filename">/srv/vhosts/packages/</code> as the root of the associated web space. The management of the archive itself is delegated to the <span class="command"><strong>mini-dinstall</strong></span> command (in the similarly-named package). This tool keeps an eye on an <code class="filename">incoming/</code> directory (in our case, <code class="filename">/srv/vhosts/packages/mini-dinstall/incoming/</code>) and waits for new packages there; when a package is uploaded, it is installed into a Debian archive at <code class="filename">/srv/vhosts/packages/</code>. The <span class="command"><strong>mini-dinstall</strong></span> command reads the <code class="filename">*.changes</code> file created when the Debian package is generated. These files contain a list of all other files associated with the version of the package (<code class="filename">*.deb</code>, <code class="filename">*.dsc</code>, <code class="filename">*.diff.gz</code>/<code class="filename">*.debian.tar.gz</code>, <code class="filename">*.orig.tar.gz</code>, or their equivalents with other compression tools), and these allow <span class="command"><strong>mini-dinstall</strong></span> to know which files to install. <code class="filename">*.changes</code> files also contain the name of the target distribution (often <code class="literal">unstable</code>) mentioned in the latest <code class="filename">debian/changelog</code> entry, and <span class="command"><strong>mini-dinstall</strong></span> uses this information to decide where the package should be installed. This is why administrators must always change this field before building a package, and set it to <code class="literal">internal</code> or <code class="literal">updates</code>, depending on the target location. <span class="command"><strong>mini-dinstall</strong></span> then generates the files required by APT, such as <code class="filename">Packages.gz</code>.
		</p>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>ALTERNATIVE</em></span> <span class="command"><strong>apt-ftparchive</strong></span></strong></p></div></div></div> 
		 <a id="id-1.18.6.9.2" class="indexterm"></a>
		 <p>
			If <span class="command"><strong>mini-dinstall</strong></span> seems too complex for your Debian archive needs, you can also use the <span class="command"><strong>apt-ftparchive</strong></span> command. This tool scans the contents of a directory and displays (on its standard output) a matching <code class="filename">Packages</code> file. In the Falcot Corp case, administrators could upload the packages directly into <code class="filename">/srv/vhosts/packages/updates/</code> or <code class="filename">/srv/vhosts/packages/internal/</code>, then run the following commands to create the <code class="filename">Packages.gz</code> files:
		</p>
		 
<pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>cd /srv/vhosts/packages</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>apt-ftparchive packages updates &gt;updates/Packages</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>gzip updates/Packages</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>apt-ftparchive packages internal &gt;internal/Packages</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>gzip internal/Packages</code></strong></pre>
		 <p>
			The <span class="command"><strong>apt-ftparchive sources</strong></span> command allows creating <code class="filename">Sources.gz</code> files in a similar fashion.
		</p>
		 </div> <p>
			Configuring <span class="command"><strong>mini-dinstall</strong></span> requires setting up a <code class="filename">~/.mini-dinstall.conf</code> file; in the Falcot Corp case, the contents are as follows:
		</p>
		 
<pre class="programlisting">
[DEFAULT]
archive_style = flat
archivedir = /srv/vhosts/packages

verify_sigs = 0
mail_to = admin@falcot.com

generate_release = 1
release_origin = Falcot Corp
release_codename = stable

[updates]
release_label = Recompiled Debian Packages

[internal]
release_label = Internal Packages
</pre>
		 <p>
			One decision worth noting is the generation of <code class="filename">Release</code> files for each archive. This can help manage package installation priorities using the <code class="filename">/etc/apt/preferences</code> configuration file (see <a class="xref" href="sect.apt-get.html#sect.apt.priorities" title="6.2.5. Các ưu tiên Quản lý Gói">Phần 6.2.5, “Các ưu tiên Quản lý Gói”</a> for details).
		</p>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>SECURITY</em></span> <span class="command"><strong>mini-dinstall</strong></span> and permissions</strong></p></div></div></div> 
		 <p>
			Since <span class="command"><strong>mini-dinstall</strong></span> has been designed to run as a regular user, there's no need to run it as root. The easiest way is to configure everything within the user account belonging to the administrator in charge of creating the Debian packages. Since only this administrator has the required permissions to put files in the <code class="filename">incoming/</code> directory, we can deduce that the administrator authenticated the origin of each package prior to deployment and <span class="command"><strong>mini-dinstall</strong></span> does not need to do it again. This explains the <code class="literal">verify_sigs = 0</code> parameter (which means that signatures need not be verified). However, if the contents of packages are sensitive, we can reverse the setting and elect to authenticate with a keyring containing the public keys of persons allowed to create packages (configured with the <code class="literal">extra_keyrings</code> parameter); <span class="command"><strong>mini-dinstall</strong></span> will then check the origin of each incoming package by analyzing the signature integrated to the <code class="filename">*.changes</code> file.
		</p>
		 </div> <p>
			Invoking <span class="command"><strong>mini-dinstall</strong></span> actually starts a daemon in the background. As long as this daemon runs, it will check for new packages in the <code class="filename">incoming/</code> directory every half-hour; when a new package arrives, it will be moved to the archive and the appropriate <code class="filename">Packages.gz</code> and <code class="filename">Sources.gz</code> files will be regenerated. If running a daemon is a problem, <span class="command"><strong>mini-dinstall</strong></span> can also be manually invoked in batch mode (with the <code class="literal">-b</code> option) every time a package is uploaded into the <code class="filename">incoming/</code> directory. Other possibilities provided by <span class="command"><strong>mini-dinstall</strong></span> are documented in its <span class="citerefentry"><span class="refentrytitle">mini-dinstall</span>
			 (1)</span> manual page.
		</p>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>EXTRA</em></span> Generating a signed archive</strong></p></div></div></div> 
		 <p>
			The APT suite checks a chain of cryptographic signatures on the packages it handles before installing them, in order to ensure their authenticity (see <a class="xref" href="sect.package-authentication.html" title="6.5. Kiểm tra Tính xác thực Gói">Phần 6.5, “Kiểm tra Tính xác thực Gói”</a>). Private APT archives can then be a problem, since the machines using them will keep displaying warnings about unsigned packages. A diligent administrator will therefore integrate private archives with the secure APT mechanism.
		</p>
		 <p>
			To help with this process, <span class="command"><strong>mini-dinstall</strong></span> includes a <code class="literal">release_signscript</code> configuration option that allows specifying a script to use for generating the signature. A good starting point is the <code class="filename">sign-release.sh</code> script provided by the <span class="pkg pkg">mini-dinstall</span> package in <code class="filename">/usr/share/doc/mini-dinstall/examples/</code>; local changes may be relevant.
		</p>
		 </div>
	</section><footer/></body></html>