<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chương 11. Những dịch vụ mạng: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP"/><link rel="prev" href="sect.network-diagnosis-tools.html" title="10.8. Network Diagnosis Tools"/><link rel="next" href="sect.http-web-server.html" title="11.2. Web Server (HTTP)"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/network-services.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.network-diagnosis-tools.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.http-web-server.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section xml:lang="vi-VN" class="chapter" id="network-services"><div class="titlepage"><div><div><h1 class="title"><a xmlns="" id="network-services"/>Chương 11. Những dịch vụ mạng: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</h1></div></div></div>
	
	 
	 <div class="highlights"> <p>
		Những dịch vụ mạng là các chương trình mà người sử dụng tương tác trực tiếp trong công việc hằng ngày. Chúng được ví như phần đỉnh của tảng băng thông tin, và trong chương này, chúng ta sẽ tập trung tìm hiểu về phần đỉnh này; các thành phần ẩn của tảng băng mà các dịch vụ này đang dựa trên chính là cơ sở hạ tầng mạng mà chúng ta đã tìm hiểu trong những phần trước.
	</p>
	 <p>
		Các dịch vụ mạng hiện nay thường yêu cầu cơ chế mã hóa để đảm bảo độ tin cậy và an toàn trong quá trình vận hành, đặc biệt khi chúng được sử dụng trên mạng Internet công cộng. Chứng chỉ X.509 (cũng được biết tới là chứng chỉ SSL hay chứng chỉ TLS) thường được sử dụng cho mục đích này. Một chứng chỉ cho một tên miền cụ thể thường được chia sẻ bởi ít nhất hai dịch vụ mạng được thảo luận trong chương này.
	</p>
	 <a id="id-1.14.3.3" class="indexterm"></a>
	 <a id="id-1.14.3.4" class="indexterm"></a>
	 <a id="id-1.14.3.5" class="indexterm"></a>
	 </div> <section class="section" id="sect.smtp-mail-server"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.smtp-mail-server"/>11.1. Máy phục vụ thư điện tử</h2></div></div></div>
		
		 <p>
			Các quản trị viên của công ty Falcot đã chọn Postfix để làm máy chủ thư điện tử của họ vì tính tin cậy của nó và sự đơn giản trong việc cấu hình. Thực vậy, thiết kế của nó đảm bảo mỗi một tác vụ (task) được thực hiện trong một tiến trình (process) với rất ít quyền được cho phép, điều này rất tốt khi nó hạn chế rất nhiều vấn đề rủi ro.
		</p>
		 <a id="id-1.14.4.3" class="indexterm"></a>
		 <a id="id-1.14.4.4" class="indexterm"></a>
		 <a id="id-1.14.4.5" class="indexterm"></a>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>LỰA CHỌN THAY THẾ</em></span> Máy phục vụ Exim4</strong></p></div></div></div> 
		 <a id="id-1.14.4.6.2" class="indexterm"></a>
		 <p>
			Debian sử dụng Exim4 làm máy chủ thư điện tử (đó là lý do tại sao các thiết lặp cài đặt bao gồm cả Exim4). Cấu hình của Exim4 được cung cấp bởi một gói riêng, <span class="pkg pkg">exim4-config</span>, và được tùy chỉnh một cách tự động bằng cách trả lời những cấu hỏi của Debconf, chúng cũng tương tự như nhưng câu hỏi cấu hình của <span class="pkg pkg">postfix</span>.
		</p>
		 <p>
			Cấu hình có thể hnằm trong từng tập tin (<code class="filename">/etc/exim4/exim4.conf.template</code>) hoặc được chia thành các đoạn cấu hình và được lưu ở <code class="filename">/etc/exim4/conf.d</code>. Trong cả hai trường hợp, các tập tin sẽ được dùng bởi lệnh <span class="command"><strong>update-exim4.conf</strong></span> như là các mẫu để sinh ra tập tin <code class="filename">/var/lib/exim4/config.autogenerated</code>. Đây là tập tin sẽ được Exim4 sử dụng. Nhờ vào cơ chế này, các giá trị lấy được trong quá trình cấu hình Exim's debconf - được lưu trong <code class="filename">/etc/exim4/update-exim4.conf.conf</code> - có thể được chèn vào tập tin cấu hình của Exim, ngay cả khi quản trị viên hay các gói khác vừa thay đổi giá trị mặc định trong cấu hình Exim.
		</p>
		 <p>
			Cú pháp của tập tin cấu hình khá phức tạp; tuy nhiên, khi đã hiểu, Exim4 là một máy phục vụ thư điện tử mạnh và hoàn thiện, như đã được chứng minh bởi hàng chục trang tài liệu hướng dẫn. <a class="ulink" href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a>
		</p>
		 </div> <section class="section" id="id-1.14.4.7"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.4.7"/>11.1.1. Cài đặt Postfix</h3></div></div></div>
			
			 <p>
				Gói phần mềm <span class="pkg pkg">postfix</span> bao gồm một dịch vụ chạy nền chủ lực SMTP. Các gói phần mềm khác (như <span class="pkg pkg">postfix-ldap</span> và <span class="pkg pkg">postfix-pgsql</span>) mang lại thêm các tính năng cho Postfix, bao gồm truy cập tới các cơ sở dữ liệu ánh xạ (mapping databases). Bạn chỉ nên cài đặt chúng khi bạn thực sự biết là bạn cần chúng.
			</p>
			 <div class="sidebar" id="sidebar.smtp"><a xmlns="" id="sidebar.smtp"/><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TRỞ VỀ CĂN BẢN</em></span> SMTP</strong></p></div></div></div> 
			 <a id="id-1.14.4.7.3.2" class="indexterm"></a>
			 <a id="id-1.14.4.7.3.3" class="indexterm"></a>
			 <a id="id-1.14.4.7.3.4" class="indexterm"></a>
			 <p>
				SMTP (<span class="emphasis"><em>Simple Mail Transfer Protocol</em></span>) là một chuẩn giao tiếp giữa các máy phục vụ thư điện tử để trao đổi và chỉ đường cho các thư điện tử.
			</p>
			 </div> <p>
				Một số câu hỏi Debconf được đưa ra trong quá trình cài đặt gói phần mềm. Các câu trả lời cho phép tạo ra phiên bản đầu tiên tập tin cấu hình <code class="filename">/etc/postfix/main.cf</code>.
			</p>
			 <p>
				Câu hỏi đầu tiên là về loại cấu hình. Chỉ có hai trong các câu trả lời được đề xuất là hữu dụng cho trường hợp một máy phục vụ có kết nối Internet, "Internet site" và "Internet with smarthost". Lựa chọn đầu tiên dành cho một máy phục vụ được sắp đặt để nhận thư điện tử đến và gửi trực tiếp thư điện tử đi tới các người nhận. Lựa chọn này phù hợp cho trường hợp của công ty Falcot. Lựa chọn thứ hai dành cho một máy phục vụ nhận thư điện tử đến như bình thường, nhưng gửi thư điện tử đi thông qua một máy phục vụ SMTP trung gian - "máy smarthost" - thay vì đi thẳng tới máy phục vụ của người nhận. Đây là trường hợp tốt nhất cho các cá nhân với một địa chỉ IP động, bởi các máy phục vụ thư điện thử từ chối các tin nhắn đến thẳng từ một địa chỉ IP như thế. Trong trường hợp này, máy tính thông minh (smarthost) sẽ là máy phục vụ SMTP của ISP, vốn luôn được cấu hình để nhận các thư điện tử đến từ các ISP và chuyển hướng nó sao cho phù hợp. Cách sắp đặt (với một máy chủ thông minh (smarthost)) cũng liên quan tới các máy phục vụ vốn không được kết nối Internet thường xuyên, vì cách này tránh được việc phải quản lý một chồng tin nhắn không thể gửi đi và cần phải được thử gửi lại sau đó.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TỪ VỰNG</em></span> ISP</strong></p></div></div></div> 
			 <a id="id-1.14.4.7.6.2" class="indexterm"></a>
			 <p>
				ISP là tên viết tắt của "Internet Service Provider". Nó bao phủ một tập thể, thông thường là một công ty, cung cấp các kết nối Internet và các dịch vụ cơ bản đi kèm khác (thư điện tử, tin tức và vâng vâng).
			</p>
			 <p>
			</p>
			 </div> <p>
				Câu hỏi thứ hai liên quan tới tên đầy đủ của máy tính, thường được dùng để tạo ra địa chỉ thư điện tử từ tên người dùng nội bộ; tên đầy đủ của máy tính thường nằm sau dấu @. Trong tình huống của Falcot, câu trả lời nên là <code class="literal">mail.falcot.com</code>. Đây là câu hỏi duy nhất được hỏi theo ngầm định, nhưng cấu hình có được từ câu hỏi này không đáp ứng hết các nhu cầu của Falcot, đó là lý do các nhà quản trị hệ thống chạy <span class="command"><strong>dpkg-reconfigure postfix</strong></span> để có thể tùy chỉnh thêm nhiều tham số.
			</p>
			 <p>
				Một trong các câu hỏi thêm hỏi về các tên miền liên quan đến chiếc máy tính này. Danh sách ngầm định bao gồm tên đầy đủ của nó và các từ đồng nghĩa cho <code class="literal">localhost</code>, nhưng tên miền chính thức <code class="literal">falcot.com</code> cần phải được thêm vào bằng tay. Tổng quát hơn, câu hỏi này nên thường được trả lời với các tên miền chiếc máy tính này đang phục vụ như là một máy phục vụ MX; nói cách khác, tất cả các tên miền mà DNS cho rằng chiếc máy tính này sẽ nhận thư điện tử cho. Thông tin này nằm trong tham biến <code class="literal">mydestination</code> của tập tin cấu hình chính của Postfix - <code class="filename">/etc/postfix/main.cf</code>.
			</p>
			 <a id="id-1.14.4.7.9" class="indexterm"></a>
			 <a id="id-1.14.4.7.10" class="indexterm"></a>
			 <div class="figure" id="id-1.14.4.7.11"><a id="id-1.14.4.7.11"/><p class="title"><strong>Hình 11.1. Vai trò của mẩu tin DNS <span class="emphasis"><em>MX</em></span> khi gửi thư</strong></p><div class="figure-contents">
				
				 <div class="mediaobject"><img src="images/mail-server.png" alt="Vai trò của mẩu tin DNS MX khi gửi thư"/></div>

			</div></div>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>THÊM</em></span> Tra cứu các mẩu tin MX</strong></p></div></div></div> 
			 <p>
				Khi DNS không có mẩu tin MX cho một tên miền, máy phục vụ thư điện tử sẽ thử tự gửi các tin nhắn tới máy đích, bắng việc sử dụng mẩu tin A tương ứng (A record) (hoặc AAAA trong IPv6).
			</p>
			 </div> <p>
				Trong một vài tình huống, quá trình cài đặt cũng có thể hỏi những mạng máy tính nào nên được cho phép để nhận thư điện tử thông qua máy tính này. Trong cấu hình ngầm định của nó, Postfix chỉ chấp nhận các thư điện tử đến từ máy tính này mà thôi; mạng máy tính nội bộ thường sẽ được thêm vào. Các nhà quản trị hệ thống của Falcot Corp đã thêm <code class="literal">192.168.0.0/16</code> vào câu trả lời ngầm định. Nếu câu hỏi không được đưa ra, một tham biến có liên quan đến điều này trong tập tin cấu hình là <code class="literal">mynetworks</code>, như được trình bày trong ví dụ dưới đây.
			</p>
			 <p>
				Thư điện tử nội bộ có thể được chuyển phát thông qua <span class="command"><strong>procmail</strong></span>. Công cụ này cho phép những người sử dụng sắp xếp thư điện tử dựa trên các nguyên tắc lưu trong tập tin <code class="filename">~/.procmailrc</code>.
			</p>
			 <a id="id-1.14.4.7.15" class="indexterm"></a>
			 <a id="id-1.14.4.7.16" class="indexterm"></a>
			 <a id="id-1.14.4.7.17" class="indexterm"></a>
			 <p>
				Sau bước đầu tiên này, những nhà quản trị hệ thống đã có được tập tin cấu hình sau đây; tập tin này sẽ được sử dụng như một điểm bắt đầu để thêm các tính năng phụ thêm trong các phần tiếp theo.
			</p>
			 <div class="example" id="id-1.14.4.7.19"><a xmlns="" id="id-1.14.4.7.19"/><p class="title"><strong>Ví dụ 11.1. Tập tin <code class="filename">/etc/postfix/main.cf</code> ban đầu</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
# Tham khảo tập tin /usr/share/postfix/main.cf.dist để xem bản có ghi chú chi tiết hơn


# Riêng cho Debian:  Đặt tên cho tập tin sẽ dùng
# dòng đầu tiên của tập tin đó làm tên. Ngầm định của Debian
# là /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# Thêm vào .domain là nhiệm vụ của MUA.
append_dot_mydomain = no

# Bỏ dấu ghi chú cho dòng tiếp theo để xuất các cảnh báo cho các thư điện tử bị "hoãn"
#delay_warning_time = 4h

readme_directory = no

# Các tham số TLS
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# Xem /usr/share/doc/postfix/TLS_README.gz trong gói phần mềm postfix-doc để biết
# cách bật SSL cho các chương trình khách smtp(smtp client).

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</pre>

			</div></div>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>AN NINH</em></span> Các chứng chỉ SSL <span class="emphasis"><em>Giả</em></span></strong></p></div></div></div> 
			 <p>
				Các chứng chỉ <span class="emphasis"><em>giả</em></span>, như những loại "thuốc" <span class="emphasis"><em>giả</em></span> bán bởi những thầy lang bất cẩn trong xã hội cũ, hoàn toàn không có giá trị: bạn không thể dựa trên chúng để chứng thực máy phục vụ bởi vì chúng là các chứng chỉ được tự ký và được tạo ra tự động. Tuy nhiên chúng rất hữu dụng để tăng cường độ riêng tư của các giao dịch.
			</p>
			 <p>
				Nhìn chung chúng chỉ nên được sử dụng cho mục đích kiểm tra, và khi hoạt động bình thường phải sử dụng chứng chỉ thực; những chứng chỉ này được tạo ra theo quy trình được mô tả trong <a class="xref" href="sect.virtual-private-network.html#sect.easy-rsa" title="10.2.1.1. Public Key Infrastructure: easy-rsa">Phần 10.2.1.1, “Public Key Infrastructure: <span class="emphasis"><em>easy-rsa</em></span>”</a>.
			</p>
			 </div>
		</section>
		 <section class="section" id="sect.configuring-virtual-domains"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.configuring-virtual-domains"/>11.1.2. Cấu hình các miền ảo (Virtual Domains)</h3></div></div></div>
			
			 <a id="id-1.14.4.8.2" class="indexterm"></a>
			 <a id="id-1.14.4.8.3" class="indexterm"></a>
			 <p>
				Máy phục vụ thư điện tử có thể nhận các thư gửi đến các miền khác ngoài miền chính; những miền này được biết đến như là miền ảo. Trong đa số các trường hợp mà điều này xảy ra, các thư điện tử thường không gửi tới người dùng nội bộ. Postfix cung cấp hai tính năng hiệu quả để xử lý các miền ảo.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>LƯU Ý</em></span> Các miền ảo và các miền chính thống</strong></p></div></div></div> 
			 <p>
				Chẳng có miền ảo nào được liệt kê trong tham biến <code class="literal">mydestination</code>; tham biến này chỉ chứa các tên của các miền "chính thống" trực tiếp liên quan tới máy này và các những người dùng nội bộ của máy này.
			</p>
			 </div> <section class="section" id="id-1.14.4.8.6"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.8.6"/>11.1.2.1. Những miền hư danh</h4></div></div></div>
				
				 <a id="id-1.14.4.8.6.2" class="indexterm"></a>
				 <a id="id-1.14.4.8.6.3" class="indexterm"></a>
				 <p>
					Một miền hư danh (virtual alias domain) chỉ chứa những danh xưng. Chúng là những địa chỉ dùng để chuyển hướng các thư điện tử tới những địa chỉ khác.
				</p>
				 <p>
					Một miền như vậy được đưa vào sử dụng bằng việc thêm tên của nó vào tham biến <code class="literal">virtual_alias_domains</code>, và liệt kê tên của một tập tin ánh xạ địa chỉ (address mapping file) vào tham biến <code class="literal">virtual_alias_maps</code>.
				</p>
				 <div class="example" id="id-1.14.4.8.6.6"><a xmlns="" id="id-1.14.4.8.6.6"/><p class="title"><strong>Ví dụ 11.2. Những dòng được thêm vào tập tin <code class="filename">/etc/postfix/main.cf</code></strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</pre>

				</div></div>
				 <p>
					Tập tin <code class="filename">/etc/postfix/virtual</code> mô tả một ánh xạ bằng một cú pháp đơn giản: mỗi dòng chứa hai trường tách ra bởi một khoảng trắng; trường đầu tiên là danh xưng(alias), trường thứ hai là một danh sách liệt những địa chỉ thư điện tử mà nó sẽ chuyển hướng tới. Địa chỉ đặc biệt <code class="literal">@domain.com</code> bao gồm tất cả những danh xưng (aliases) trong một miền (domain).
				</p>
				 <div class="example" id="id-1.14.4.8.6.8"><a xmlns="" id="id-1.14.4.8.6.8"/><p class="title"><strong>Ví dụ 11.3. Ví dụ cho tập tin <code class="filename">/etc/postfix/virtual</code></strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# Danh xưng dưới đây là rất chung chung và bao gồm tất cả những địa chỉ trong
# tên miền falcotsbrand.com vốn trên thực tế không được kể đến trong tập tin này.
# Những địa chỉ này chuyển hướng thư đến những địa chỉ với cùng tên người dùng trong
# miền falcot.com.
@falcotsbrand.com           @falcot.com</pre>

				</div></div>

			</section>
			 <section class="section" id="id-1.14.4.8.7"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.8.7"/>11.1.2.2. Những miền có hộp thư ảo</h4></div></div></div>
				
				 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CẢNH BÁO</em></span> Miền ảo phối hợp</strong></p></div></div></div> 
				 <p>
					Postfix không cho phép sử dụng một miền cho cả <code class="literal">virtual_alias_domains</code> và <code class="literal">virtual_mailbox_domains</code>. Tuy nhiên, mỗi miền của <code class="literal">virtual_mailbox_domains</code> được hiểu ngầm là được liệt kê trong <code class="literal">virtual_alias_domains</code>. Điều đó cho phép trộn lẫn các danh xưng(alias) và các hộp thư trong một miền ảo.
				</p>
				 </div> <a id="id-1.14.4.8.7.3" class="indexterm"></a>
				 <a id="id-1.14.4.8.7.4" class="indexterm"></a>
				 <p>
					Những tin nhắn được gửi đến một miền có hộp thư ảo được lưu lại trong các hộp thư ảo vốn không dành cho một người dùng nội bộ nào.
				</p>
				 <p>
					Bật một miền có hộp thư ảo buộc phải đặt tên miền này trong tham biến <code class="literal">virtual_mailbox_domains</code>, và liệt kê tập tin ánh xạ hộp thư trong <code class="literal">virtual_mailbox_maps</code>. Tham biến <code class="literal">virtual_mailbox_base</code> chứa thư mục vốn được dùng để lưu trữ các hộp thư.
				</p>
				 <p>
					Tham biến <code class="literal">virtual_uid_maps</code> (và <code class="literal">virtual_gid_maps</code>) tham chiếu một tập tin chứa một ánh xa giữa địa chỉ email và người dùng cấp hệ thống (và nhóm) "sở hữu" hộp thư tương ứng đó. Để có tất cả những hộp thư sở hữu bởi cùng một người/nhóm, cú pháp <code class="literal">static:5000</code> gán một UID/GID cố định (có giá trị 5000 như trong trường hợp này)
				</p>
				 <div class="example" id="id-1.14.4.8.7.8"><a xmlns="" id="id-1.14.4.8.7.8"/><p class="title"><strong>Ví dụ 11.4. Những dòng được thêm vào tập tin <code class="filename">/etc/postfix/main.cf</code></strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</pre>

				</div></div>
				 <p>
					Một lần nữa, cú pháp của tập tin <code class="filename">/etc/postfix/vmailbox</code> khá dễ hiểu: hai trường tách ra bởi một khoảng trắng. Trường đầu tiên là một địa chỉ thư điện thử nằm trong một trong số những miền ảo, và trường thứ hai là địa chỉ của hộp thư tương ứng (địa chỉ tương đối so với thư mục được chỉ ra trong <span class="emphasis"><em>virtual_mailbox_base</em></span>). Nếu tên hộp thư điện tử kết thúc bằng một dấu xuyệt (<code class="literal">/</code>), những thư điện tử sẽ được lưu dưới định dạng <span class="emphasis"><em>maildir</em></span>; nếu không, định dạng <span class="emphasis"><em>mbox</em></span> truyền thống sẽ được sử dụng. Định dạng <span class="emphasis"><em>maildir</em></span> sử dụng toàn bộ một thư mục để lưu trữ một hộp thư, mỗi tin nhắn một được lưu trong một tập tin độc lập." Ngược lại, dưới định dạng <span class="emphasis"><em>mbox</em></span>, toàn bộ hộp thư điện tử được lưu trong một tập tin, và mỗi dòng bắt đầu bằng “<code class="literal">From </code>” (<code class="literal">From</code> theo sau bởi khoảng trắng) báo hiệu tiếp theo là một thông điệp mới.
				</p>
				 <div class="example" id="id-1.14.4.8.7.10"><a xmlns="" id="id-1.14.4.8.7.10"/><p class="title"><strong>Ví dụ 11.5. Tập tin <code class="filename">/etc/postfix/vmailbox</code></strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
# Thư điện tử của Jean được lưu dưới định dạng maildir, với
# mỗi một tập tin cho một thư điện tử nằm trong một thư mục riêng
jean@falcot.org falcot.org/jean/
# Thư điện tử của Sophie được lưu trong một tập tin "mbox" truyền thống,
# với tất cả các thư điện tử được nối lại với nhau thành một tập tin duy nhất
sophie@falcot.org falcot.org/sophie</pre>

				</div></div>

			</section>

		</section>
		 <section class="section" id="sect.restrictions-for-receiving-and-sending"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.restrictions-for-receiving-and-sending"/>11.1.3. Giới hạn cho việc Nhận và Gửi</h3></div></div></div>
			
			 <p>
				Sự tăng trưởng về số lượng những thư điện tử gửi với số lượng lớn mà không có yêu cầu (<span class="emphasis"><em>spam</em></span>) buộc phải nghiêm khắc hơn khi quyết định thư điện tử nào một máy phục vụ nên nhận. Phần này trình bày một số chiến thuật được kèm trong Postfix.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>VĂN HÓA</em></span> Vấn đề spam</strong></p></div></div></div> 
			 <a id="id-1.14.4.9.3.2" class="indexterm"></a>
			 <p>
				“Spam” là một khái niệm chung bao quát tất cả những thư điện tử mang tính thương mại không có ai yêu cầu nhận (cũng được biết đến là các UCE) vốn làm ngập úng các hộp thư điện tử; các cá nhân vô trách nhiệm gửi chúng ra được gọi là những spammer. Họ quan tâm rất ít về những thứ họ gây ra, bởi việc gửi một thư điện tử tốn rất ít tiền, và chỉ cần có một lượng nhỏ trong những người nhận bị thu hút bởi những lời mời chào này là làm cho công việc gửi thư rác thu nhiều lời hơn là lỗ. Quy trình thì gần như là tự động hoàn toàn, và bất kỳ một địa chỉ thư điện tử nào được sử dụng công cộng (ví dụ như, trên một diễn dàn trên mạng, hoặc trên những kho lưu trữ của một bó thư điện tử (mailing list), hoặc trên một nhật ký điện tử(blog), và vâng vâng) sẽ được khám phá ra bởi những con rô-bốt của những spammer, và sẽ dễ nhận một chuỗi dài vô tận những thông điệp mà không ai yêu cầu.
			</p>
			 <p>
				Những quản trị hệ thống cố gắng đối mặt với vấn đề này bằng các bộ lọc thư rác, nhưng dĩ nhiên những spammer luôn cố gắng xoay sở để vượt qua các bộ lọc này. Một số thậm chí thuê một mạng máy tính nhiễm các loại sâu máy tính (worm) được tạo ra bởi các nhóm tội phạm. Thông số gần đây ước chừng có đến 95% của tất cả thư điện tử di chuyển trên Internet là thư rác (spam).
			</p>
			 </div> <section class="section" id="id-1.14.4.9.4"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.4"/>11.1.3.1. Những giới hạn truy cập dựa trên IP</h4></div></div></div>
				
				 <p>
					Tham biến <code class="literal">smtpd_client_restrictions</code> kiểm soát những máy nào được cho phép để giao tiếp với máy phục vụ thư điện tử.
				</p>
				 <div class="example" id="id-1.14.4.9.4.3"><a xmlns="" id="id-1.14.4.9.4.3"/><p class="title"><strong>Ví dụ 11.6. Những giới hạn dựa trên địa chỉ máy khách</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</pre>

				</div></div>
				 <p>
					Khi một tham biến chứa một danh sách những quy tắc, như trong ví dụ ở trên, những quy tắc được thực thi theo thứ tự, từ đầu tiên đến cuối cùng. Mỗi quy tắc có thể nhận một thông điệp, từ chối nó, hoặc để việc quyết định đó cho quy tắc nằm phía sau. Do đó, thứ tự là quan trọng, và đơn giản hoán đổi giữa hai quy tắc có thể dẫn đến cách hoạt động hoàn toàn khác.
				</p>
				 <p>
					Chỉ thị <code class="literal">permit_mynetworks</code>, vốn được sử dụng như quy tắc đầu tiên, chấp nhận tất cả những thư điện tử đến từ một máy tính trong mạng nội bộ (như được định nghĩa trong tham biến cấu hình <span class="emphasis"><em>mynetworks</em></span>)
				</p>
				 <p>
					Chỉ thị thứ hai thông thường sẽ từ chối những thư điện tử đến từ những máy tính không có cấu hình DNS tuyệt đối hợp lệ. Một cấu hình như vậy nghĩa là địa chỉ IP đó có thể được giải mã sang một tên, và tên này, tới lượt của nó, sẽ được giải mã sang một địa chỉ IP. Sự giới hạn này thông thường quá nghiêm khắc, bởi vì nhiều máy phục vụ thư điện tử không có một DNS phiên mã ngược cho địa chỉ IP. Điều này giải thích vì sau các nhà quản trị hệ thống của Falcot thêm từ bổ nghĩa <code class="literal">warn_if_reject</code> vào phía trước chỉ thị <code class="literal">reject_unknown_client</code>: từ bổ nghĩa này chuyển sự từ chối đó thành một cảnh báo đơn giản ghi lại trong các nhật ký. Những nhà quản trị hệ thống có thể theo dõi số lượng thông điệp đáng lẽ sẽ bị từ chối nếu quy tắc này được đưa vào hoạt động, và ra một quyết định đúng đắn sau đó nếu họ thực sự muốn điều đó hay không.
				</p>
				 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>THÔNG TIN THÊM</em></span> Những bảng <span class="emphasis"><em>truy cập</em></span></strong></p></div></div></div> 
				 <p>
					Các điều kiện giới hạn bao gồm các bảng, điều chỉnh được bởi nhà quản trị hệ thống, liệt kê những xâu chuỗi thông tin của những người gửi, địa chỉ IP, và những tên của những máy cho phép hay bị cấm. Những bảng này có thể được tạo ra từ một bản sao đã được giải nén của tập tin <code class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code>. Bản mẫu này được mô tả trong những ghi chú của nó, nghĩa là từng bảng mô tả cú pháp riêng của nó.
				</p>
				 <p>
					Bảng <code class="filename">/etc/postfix/access_clientip</code> liệt kê những địa chỉ IP và những mạng máy tính; <code class="filename">/etc/postfix/access_helo</code> liệt kê những tên miền; <code class="filename">/etc/postfix/access_sender</code> chứa những địa chỉ thư điện tử người gửi. Tất cả những tập tin này cần phải được chuyển thành những bảng hash (một định dạng được tối ưu hóa cho truy cập tức thời) sau mỗi thay đổi, với lệnh <span class="command"><strong>postmap /etc/postfix/<em class="replaceable">file</em></strong></span>
				</p>
				 </div> <p>
					Chỉ thị thứ ba cho phép quản trị hệ thống sắp đặt một danh sách đen và một danh sách trắng (cho phép) những máy phục vụ thư điện tử, lưu trong tập tin <code class="filename">/etc/postfix/access_clientip</code>. Các máy phục vụ trong danh sách trắng được xem là đáng tin cậy, và những thư điện tử đến từ những nơi này không cần phải đi qua các quy tắc lọc sau đây.
				</p>
				 <p>
					Hai quy tắc cuối từ chối bất kỳ thông điệp nào đến từ một máy phục vụ được kể đến trong một trong các danh sách đen được liệt kê. RBL là một từ viết tắt cho <span class="emphasis"><em>Danh sách Đen Từ xa (Remote Black List)</em></span>; có một vài danh sách như vậy, nhưng chúng đều liệt kê các máy phục vụ được cấu hình sai mà các spammer sử dụng để chuyển phát các thư điện tử của chúng, cũng như các máy chuyển phát thư điện tử không ngờ tới khác như là các máy bị nhiễm sâu máy tính hay vi-rút.
				</p>
				 <a id="id-1.14.4.9.4.10" class="indexterm"></a>
				 <a id="id-1.14.4.9.4.11" class="indexterm"></a>
				 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>Thông tin thêm</em></span> Danh sách trắng và RBLs</strong></p></div></div></div> 
				 <p>
					Các danh sách đen thỉnh thoảng bao gồm một máy phục vụ hợp pháp vừa mới trải qua một tai nạn. Trong những trường hợp như thế này, tất cả những thư điện tử đến từ một trong những máy phục vụ như thế sẽ bị từ chối trừ khi máy phục vụ đó được liệt kê trong danh sách trắng trong <code class="filename">/etc/postfix/access_clientip</code>.
				</p>
				 <p>
					Để tránh hậu họa về sau, danh sách trắng được khuyến cáo nên bao gồm tất cả những máy phục vụ tin tưởng được mà từ đó nhiều thư điện tử thường xuyên được nhận.
				</p>
				 </div>
			</section>
			 <section class="section" id="id-1.14.4.9.5"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.5"/>11.1.3.2. Kiểm tra Sự hợp lệ của các lệnh <code class="literal">EHLO</code> hay <code class="literal">HELO</code></h4></div></div></div>
				
				 <p>
					Mỗi giao tiếp SMTP bắt đầu bằng một lệnh <code class="literal">HELO</code> (hoặc <code class="literal">EHLO</code>), theo sau bởi tên của một máy phục vụ thư điện tử gửi tới; kiểm tra sự hợp lệ của tên này có thể thú vị.
				</p>
				 <a id="id-1.14.4.9.5.3" class="indexterm"></a>
				 <a id="id-1.14.4.9.5.4" class="indexterm"></a>
				 <div class="example" id="id-1.14.4.9.5.5"><a xmlns="" id="id-1.14.4.9.5.5"/><p class="title"><strong>Ví dụ 11.7. Giới hạn về tên được công bố trong <code class="literal">EHLO</code></strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</pre>

				</div></div>
				 <p>
					Chỉ thị đầu tiên <code class="literal">permit_mynetworks</code> cho phép tất cả các máy tính trên mạng nội bộ được tự giới thiệu một cách thoải mái. Đó là điều quan trọng, bởi vì một vài chương trình thư điện tử không tôn trọng phần này của nghi thức SMTP một cách đủ nghiêm túc, và họ có thể tự trình diện với những tên không hợp lệ.
				</p>
				 <p>
					Quy tắc <code class="literal">reject_invalid_hostname</code> từ chối những thư điện tử khi <code class="literal">EHLO</code> công bố cho các danh sách một tên máy tính sai cú pháp. Quy tắc <code class="literal">reject_non_fqdn_hostname</code> từ chối những thông điệp khi tên máy tính được công bố không phải là một tên miền hoàn toàn đầy đủ và hợp lệ (bao gồm một tên miền và và một tên máy). Quy tắc <code class="literal">reject_unknown_hostname</code> từ chối những thông điệp nếu tên được công bố không tồn tại trong dns. Vì quy tắc cuối này không may dẫn đến quá nhiều sự từ chối, các nhà quản trị hệ thống thay hệ quả của nó bằng một cảnh báo đơn giản với tiền tố này <code class="literal">warn_if_reject</code> như là bước đầu tiên; họ có thể quyết định xóa bỏ tiền tố này ở các bước sau đó sau khi theo dõi những những kết quả của quy tắc này.
				</p>
				 <p>
					Sử dụng <code class="literal">permit_mynetworks</code> như là quy tắc đầu tiên có một tác dụng phụ thú vị: những quy tắc đứng phía sau chỉ chỉ áp dụng được với những máy tính nằm ngoài mạng nội bộ. Điều này cho phép đưa vào danh sách đen tất cả những máy tính công bố với bên ngoài rằng chúng là một phần của <code class="literal">falcot.com</code>, ví dụ như bằng cách thêm dòng <code class="literal">falcot.com REJECT You are not in our network!</code> vào tập tin <code class="filename">/etc/postfix/access_helo</code>.
				</p>

			</section>
			 <section class="section" id="id-1.14.4.9.6"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.6"/>11.1.3.3. Chấp nhận hoặc Từ chối dựa trên Người gửi Được công bố</h4></div></div></div>
				
				 <p>
					Mỗi tin nhắn đều có một người gửi, được thông báo bởi lệnh <code class="literal">MAIL FROM</code> của giao thức SMTP; một lần nữa, thông tin này có thể được kiểm tra bằng nhiều cách.
				</p>
				 <a id="id-1.14.4.9.6.3" class="indexterm"></a>
				 <a id="id-1.14.4.9.6.4" class="indexterm"></a>
				 <div class="example" id="id-1.14.4.9.6.5"><a xmlns="" id="id-1.14.4.9.6.5"/><p class="title"><strong>Ví dụ 11.8. Kiểm tra dựa trên người gửi</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</pre>

				</div></div>
				 <p>
					Bảng <code class="filename">/etc/postfix/access_sender</code> ánh xạ một số cách xử lý đặc biệt với một số người gửi.
				</p>
				 <p>
					Quy tắc <code class="literal">reject_unknown_sender_domain</code> buộc phải có một miền người gửi hợp lệ, bởi vì điều đó là cần thiết cho một điạ chỉ hợp lệ. Quy tắc <code class="literal">reject_unlisted_sender</code> từ chối những người gửi nội bộ nếu địa chỉ đó không tồn tại; điều này chống các thư điện tử khỏi việc bị gửi từ một địa chỉ không hợp lệ trong miền <code class="literal">falcot.com</code>, và những thông điệp xuất phát từ <code class="literal">joe.bloggs@falcot.com</code> chỉ được nhận nếu địa chỉ đó thực sự tồn tại.
				</p>
				 <p>
					Cuối cùng, quy tắc <code class="literal">reject_non_fqdn_sender</code> từ chối những thư điện tử tự cho là xuất phát từ những địa chỉ không có một tên miền đầy đủ và hợp lệ. Trên thực tế, điều này đồng nghĩa với việc từ chối những thư điện tử đến từ <code class="literal">user@machine</code>: địa chỉ phải được công bố như <code class="literal">user@machine.example.com</code> hay <code class="literal">user@example.com</code>.
				</p>

			</section>
			 <section class="section" id="id-1.14.4.9.7"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.7"/>11.1.3.4. Chấp nhận hoặc từ chối dựa trên người nhận</h4></div></div></div>
				
				 <p>
					Mỗi thư điện tử có ít nhất một người nhận, được công bố bằng lệnh <code class="literal">RCPT TO</code> của giao thức SMTP. Những địa chỉ này cũng đảm bảo tính hợp lệ, ngay cả khi việc kiểm tra nó ít liên quan hơn việc kiểm tra dựa trên địa chỉ người gửi.
				</p>
				 <a id="id-1.14.4.9.7.3" class="indexterm"></a>
				 <a id="id-1.14.4.9.7.4" class="indexterm"></a>
				 <div class="example" id="id-1.14.4.9.7.5"><a xmlns="" id="id-1.14.4.9.7.5"/><p class="title"><strong>Ví dụ 11.9. Các kiểm tra trên người nhận</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</pre>

				</div></div>
				 <p>
					<code class="literal">reject_unauth_destination</code> là quy tắc cơ bản vốn buộc những thông điệp bên ngoài phải được gửi đến chúng ta; những thông điệp được gửi đến một địa chỉ không được phục vụ bởi máy phục vụ này sẽ bị từ chối. Nếu không có quy tắc này, một máy phục vụ trở thành một điểm trung chuyển mở cho phép những spammer gửi các thư điện tư mà không ai yêu cầu; vì thế quy tắc này là bắt buộc, và nó nên được thêm vào ở gần cuối của danh sách, để không có quy tắc nào khác cho phép những thông điệp như thế này qua trước khi điểm đến đã được kiểm tra.
				</p>
				 <p>
					Quy tắc <code class="literal">reject_unlisted_recipient</code> từ chối những thông điệp được gửi đến những người dùng nội bộ không có tồn tại, vốn nghe rất có lý. Cuối cùng, quy tắc <code class="literal">reject_non_fqdn_recipient</code> từ chối các địa chỉ không đúng chuẩn; và điều này chặn việc gửi một thư điện tử tới <code class="literal">jean</code> hay <code class="literal">jean@machine</code>, và buộc phải sử dụng địa chỉ đầy đủ, ví dụ như <code class="literal">jean@machine.falcot.com</code> hoặc <code class="literal">jean@falcot.com</code>.
				</p>

			</section>
			 <section class="section" id="id-1.14.4.9.8"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.8"/>11.1.3.5. Những giới hạn liên quan tới lệnh <code class="literal">DATA</code></h4></div></div></div>
				
				 <p>
					Lệnh <code class="literal">DATA</code> của SMTP được xuất ra trước nội dung của thông điệp. Nó không cung cấp bất kỳ thông tin nào khác, ngoài việc công bố những gì xuất hiện tiếp theo. Nó vẫn có thể bị kiểm tra.
				</p>
				 <a id="id-1.14.4.9.8.3" class="indexterm"></a>
				 <div class="example" id="id-1.14.4.9.8.4"><a xmlns="" id="id-1.14.4.9.8.4"/><p class="title"><strong>Ví dụ 11.10. Những lần kiểm tra <code class="literal">DATA</code></strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining</pre>

				</div></div>
				 <p>
					Những chỉ thị <code class="literal">reject_unauth_pipelining</code> làm cho thông điệp bị từ chối nếu bên gửi gửi ra một lệnh trước khi câu trả lời cho một lệnh trước đó được gửi ra. Điều này phòng chống được một loại tối ưu hóa phổ biến được sử dụng bởi các rô-bốt spammer, bởi chúng thường không quan tâm gì về những câu trả lời và chỉ tập trung vào việc gửi càng nhiều thư điện tử càng tốt và trong thời gian ngắn nhất có thể.
				</p>

			</section>
			 <section class="section" id="id-1.14.4.9.9"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.9"/>11.1.3.6. Áp đặt những giới hạn</h4></div></div></div>
				
				 <p>
					Mặc dù những lệnh trên đều kiểm tra tính hợp lệ của các thông tin ở nhiều giai đoạn trong một quá trình trao đổi SMTP, Postfix chỉ gửi ra những sự từ chối thực sự như là một câu trả lời cho lệnh <code class="literal">RCPT TO</code>.
				</p>
				 <p>
					Điều này có nghĩa là thậm chí nếu thông điệp bị từ chối bởi một lệnh không hợp lệ <code class="literal">EHLO</code>, Postfix biết người gửi và người nhận khi công bố một sự từ chối. Nó sau đó có thể ghi lại nhật ký một thông điệp chặt chẽ hơn so với khi một giao dịch bị ngắt quãng ngay từ đầu. Hơn nữa, nhiều chương trình khách SMTP(SMTP clients) không tính trước những sự cố này sẽ xảy ra ở những lệnh SMTP đầu, và những chương trình khách này sẽ bị làm phiền bởi sự từ chối trễ này.
				</p>
				 <p>
					Lợi thế cuối cùng của lựa chọn này là những quy tắc có thể tích tụ thông tin lại trong các giai đoạn của quá trình trao đổi SMTP; điều này cho phép việc định nghĩa những sự cho phép chi tiết hơn, như là việc từ chối một kết nối mạng không phải là nội bộ nếu nó tự công bố nó với một người gửi nội bộ.
				</p>

			</section>
			 <section class="section" id="id-1.14.4.9.10"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.4.9.10"/>11.1.3.7. Filtering Based on the Message Contents</h4></div></div></div>
				
				 <p>
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</p>
				 <div class="example" id="id-1.14.4.9.10.3"><a xmlns="" id="id-1.14.4.9.10.3"/><p class="title"><strong>Ví dụ 11.11. Enabling content-based filters</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre>

				</div></div>
				 <a id="id-1.14.4.9.10.4" class="indexterm"></a>
				 <p>
					Both files contain a list of regular expressions (commonly known as <span class="emphasis"><em>regexps</em></span> or <span class="emphasis"><em>regexes</em></span>) and associated actions to be triggered when the email headers (or body) match the expression.
				</p>
				 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>QUICK LOOK</em></span> Regexp tables</strong></p></div></div></div> 
				 <p>
					The <code class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> file contains many explanatory comments and can be used as a starting point for creating the <code class="filename">/etc/postfix/header_checks</code> and <code class="filename">/etc/postfix/body_checks</code> files.
				</p>
				 </div> <div class="example" id="id-1.14.4.9.10.7"><a xmlns="" id="id-1.14.4.9.10.7"/><p class="title"><strong>Ví dụ 11.12. Example <code class="filename">/etc/postfix/header_checks</code> file</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre>

				</div></div>
				 <div class="sidebar" id="sidebar.regexp"><a xmlns="" id="sidebar.regexp"/><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>BACK TO BASICS</em></span> Regular expression</strong></p></div></div></div> 
				 <p>
					The <span class="emphasis"><em>regular expression</em></span> term (shortened to <span class="emphasis"><em>regexp</em></span> or <span class="emphasis"><em>regex</em></span>) references a generic notation for expressing a description of the contents and/or structure of a string of characters. Certain special characters allow defining alternatives (for instance, <code class="literal">foo|bar</code> matches either “foo” or “bar”), sets of allowed characters (for instance, <code class="literal">[0-9]</code> means any digit, and <code class="literal">.</code> — a dot — means any character), quantifications (<code class="literal">s?</code> matches either <code class="literal">s</code> or the empty string, in other words 0 or 1 occurrence of <code class="literal">s</code>; <code class="literal">s+</code> matches one or more consecutive <code class="literal">s</code> characters; and so on). Parentheses allow grouping search results.
				</p>
				 <p>
					The precise syntax of these expressions varies across the tools using them, but the basic features are similar. <a class="ulink" href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a>
				</p>
				 </div> <p>
					The first one checks the header mentioning the email software; if <code class="literal">GOTO Sarbacane</code> (a bulk email software) is found, the message is rejected. The second expression controls the message subject; if it mentions a virus notification, we can decide not to reject the message but to discard it immediately instead.
				</p>
				 <p>
					Using these filters is a double-edged sword, because it is easy to make the rules too generic and to lose legitimate emails as a consequence. In these cases, not only the messages will be lost, but their senders will get unwanted (and annoying) error messages.
				</p>

			</section>

		</section>
		 <section class="section" id="sect.setting-up-greylisting"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.setting-up-greylisting"/>11.1.4. Setting Up <span class="foreignphrase"><em class="foreignphrase">greylisting</em></span></h3></div></div></div>
			
			 <a id="id-1.14.4.10.2" class="indexterm"></a>
			 <p>
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</p>
			 <p>
				Postfix doesn't provide greylisting natively, but there is a feature by which the decision to accept or reject a given message can be delegated to an external program. The <span class="pkg pkg">postgrey</span> package contains just such a program, designed to interface with this access policy delegation service.
			</p>
			 <p>
				Once <span class="pkg pkg">postgrey</span> is installed, it runs as a daemon and listens on port 10023. Postfix can then be configured to use it, by adding the <code class="literal">check_policy_service</code> parameter as an extra restriction:
			</p>
			 
<pre class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre>
			 <p>
				Each time Postfix reaches this rule in the ruleset, it will connect to the <span class="command"><strong>postgrey</strong></span> daemon and send it information concerning the relevant message. On its side, Postgrey considers the IP address/sender/recipient triplet and checks in its database whether that same triplet has been seen recently. If so, Postgrey replies that the message should be accepted; if not, the reply indicates that the message should be temporarily rejected, and the triplet gets recorded in the database.
			</p>
			 <p>
				The main disadvantage of greylisting is that legitimate messages get delayed, which is not always acceptable. It also increases the burden on servers that send many legitimate emails.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>IN PRACTICE</em></span> Shortcomings of greylisting</strong></p></div></div></div> 
			 <p>
				Theoretically, greylisting should only delay the first mail from a given sender to a given recipient, and the typical delay is in the order of minutes. Reality, however, can differ slightly. Some large ISPs use clusters of SMTP servers, and when a message is initially rejected, the server that retries the transmission may not be the same as the initial one. When that happens, the second server gets a temporary error message due to greylisting too, and so on; it may take several hours until transmission is attempted by a server that has already been involved, since SMTP servers usually increase the delay between retries at each failure.
			</p>
			 <p>
				As a consequence, the incoming IP address may vary in time even for a single sender. But it goes further: even the sender address can change. For instance, many mailing-list servers encode extra information in the sender address so as to be able to handle error messages (known as <span class="emphasis"><em>bounces</em></span>). Each new message sent to a mailing-list may then need to go through greylisting, which means it has to be stored (temporarily) on the sender's server. For very large mailing-lists (with tens of thousands of subscribers), this can soon become a problem.
			</p>
			 <p>
				To mitigate these drawbacks, Postgrey manages a whitelist of such sites, and messages emanating from them are immediately accepted without going through greylisting. This list can easily be adapted to local needs, since it is stored in the <code class="filename">/etc/postgrey/whitelist_clients</code> file.
			</p>
			 </div> <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>GOING FURTHER</em></span> Selective greylisting with <span class="pkg pkg">milter-greylist</span></strong></p></div></div></div> 
			 <p>
				The drawbacks of greylisting can be mitigated by only using greylisting on the subset of clients that are already considered as probable sources of spam (because they are listed in a DNS blacklist). This is not possible with <span class="pkg pkg">postgrey</span> but <span class="pkg pkg">milter-greylist</span> can be used in such a way.
			</p>
			 <p>
				In that scenario, since DNS blacklists never triggers a definitive rejection, it becomes reasonable to use aggressive blacklists, including those listing all dynamic IP addresses from ISP clients (such as <code class="literal">pbl.spamhaus.org</code> or <code class="literal">dul.dnsbl.sorbs.net</code>).
			</p>
			 <p>
				Since milter-greylist uses Sendmail's milter interface, the postfix side of its configuration is limited to “<code class="literal">smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</code>”. The <span class="citerefentry"><span class="refentrytitle">greylist.conf</span>
				(5)</span> manual page documents <code class="filename">/etc/milter-greylist/greylist.conf</code> and the numerous ways to configure milter-greylist. You will also have to edit <code class="filename">/etc/default/milter-greylist</code> to actually enable the service.
			</p>
			 </div>
		</section>
		 <section class="section" id="id-1.14.4.11"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.4.11"/>11.1.5. Customizing Filters Based On the Recipient</h3></div></div></div>
			
			 <p>
				<a class="xref" href="network-services.html#sect.restrictions-for-receiving-and-sending" title="11.1.3. Giới hạn cho việc Nhận và Gửi">Phần 11.1.3, “Giới hạn cho việc Nhận và Gửi”</a> and <a class="xref" href="network-services.html#sect.setting-up-greylisting" title="11.1.4. Setting Up greylisting">Phần 11.1.4, “Setting Up <span class="foreignphrase"><em class="foreignphrase">greylisting</em></span>”</a> reviewed many of the possible restrictions. They all have their use in limiting the amount of received spam, but they also all have their drawbacks. It is therefore more and more common to customize the set of filters depending on the recipient. At Falcot Corp, greylisting is interesting for most users, but it hinders the work of some users who need low latency in their emails (such as the technical support service). Similarly, the commercial service sometimes has problems receiving emails from some Asian providers who may be listed in blacklists; this service asked for a non-filtered address so as to be able to correspond.
			</p>
			 <p>
				Postfix provides such a customization of filters with a “restriction class” concept. The classes are declared in the <code class="literal">smtpd_restriction_classes</code> parameter, and defined the same way as <code class="literal">smtpd_recipient_restrictions</code>. The <code class="literal">check_recipient_access</code> directive then defines a table mapping a given recipient to the appropriate set of restrictions.
			</p>
			 <div class="example" id="id-1.14.4.11.4"><a xmlns="" id="id-1.14.4.11.4"/><p class="title"><strong>Ví dụ 11.13. Defining restriction classes in <code class="filename">main.cf</code></strong></p><div class="example-contents">
				
				 
<pre class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre>

			</div></div>
			 <div class="example" id="id-1.14.4.11.5"><a xmlns="" id="id-1.14.4.11.5"/><p class="title"><strong>Ví dụ 11.14. The <code class="filename">/etc/postfix/recipient_access</code> file</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre>

			</div></div>

		</section>
		 <section class="section" id="sect.postfix-antivirus"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.postfix-antivirus"/>11.1.6. Integrating an Antivirus</h3></div></div></div>
			
			 <a id="id-1.14.4.12.2" class="indexterm"></a>
			 <p>
				The many viruses circulating as attachments to emails make it important to set up an antivirus at the entry point of the company network, since despite an awareness campaign, some users will still open attachments from obviously shady messages.
			</p>
			 <p>
				The Falcot administrators selected <span class="command"><strong>clamav</strong></span> for their free antivirus. The main package is <span class="pkg pkg">clamav</span>, but they also installed a few extra packages such as <span class="pkg pkg">arj</span>, <span class="pkg pkg">unzoo</span>, <span class="pkg pkg">unrar</span> and <span class="pkg pkg">lha</span>, since they are required for the antivirus to analyze attachments archived in one of these formats.
			</p>
			 <a id="id-1.14.4.12.5" class="indexterm"></a>
			 <a id="id-1.14.4.12.6" class="indexterm"></a>
			 <p>
				The task of interfacing between antivirus and the email server goes to <span class="command"><strong>clamav-milter</strong></span>. A <span class="emphasis"><em>milter</em></span> (short for <span class="emphasis"><em>mail filter</em></span>) is a filtering program specially designed to interface with email servers. A milter uses a standard application programming interface (API) that provides much better performance than filters external to the email servers. Milters were initially introduced by <span class="emphasis"><em>Sendmail</em></span>, but <span class="emphasis"><em>Postfix</em></span> soon followed suit.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>QUICK LOOK</em></span> A milter for Spamassassin</strong></p></div></div></div> 
			 <a id="id-1.14.4.12.8.2" class="indexterm"></a>
			 <p>
				The <span class="pkg pkg">spamass-milter</span> package provides a milter based on <span class="emphasis"><em>SpamAssassin</em></span>, the famous unsolicited email detector. It can be used to flag messages as probable spams (by adding an extra header) and/or to reject the messages altogether if their “spamminess” score goes beyond a given threshold.
			</p>
			 </div> <p>
				Once the <span class="pkg pkg">clamav-milter</span> package is installed, the milter should be reconfigured to run on a TCP port rather than on the default named socket. This can be achieved with <span class="command"><strong>dpkg-reconfigure clamav-milter</strong></span>. When prompted for the “Communication interface with Sendmail”, answer “<code class="literal">inet:10002@127.0.0.1</code>”.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>NOTE</em></span> Real TCP port vs named socket</strong></p></div></div></div> 
			 <p>
				The reason why we use a real TCP port rather than the named socket is that the postfix daemons often run chrooted and do not have access to the directory hosting the named socket. You could also decide to keep using a named socket and pick a location within the chroot (<code class="filename">/var/spool/postfix/</code>).
			</p>
			 </div> <p>
				The standard ClamAV configuration fits most situations, but some important parameters can still be customized with <span class="command"><strong>dpkg-reconfigure clamav-base</strong></span>.
			</p>
			 <p>
				The last step involves telling Postfix to use the recently-configured filter. This is a simple matter of adding the following directive to <code class="filename">/etc/postfix/main.cf</code>:
			</p>
			 
<pre class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre>
			 <p>
				If the antivirus causes problems, this line can be commented out, and <span class="command"><strong>service postfix reload</strong></span> should be run so that this change is taken into account.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>IN PRACTICE</em></span> Testing the antivirus</strong></p></div></div></div> 
			 <p>
				Once the antivirus is set up, its correct behavior should be tested. The simplest way to do that is to send a test email with an attachment containing the <code class="filename">eicar.com</code> (or <code class="filename">eicar.com.zip</code>) file, which can be downloaded online: <a class="ulink" href="http://www.eicar.org/86-0-Intended-use.html">http://www.eicar.org/86-0-Intended-use.html</a>
			</p>
			 <p>
				This file is not a true virus, but a test file that all antivirus software on the market diagnose as a virus to allow checking installations.
			</p>
			 </div> <p>
				All messages handled by Postfix now go through the antivirus filter.
			</p>

		</section>
		 <section class="section" id="sect.authenticated-smtp"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.authenticated-smtp"/>11.1.7. Authenticated SMTP</h3></div></div></div>
			
			 <p>
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</p>
			 <p>
				SMTP authentication in Postfix relies on SASL (<span class="emphasis"><em>Simple Authentication and Security Layer</em></span>). It requires installing the <span class="pkg pkg">libsasl2-modules</span> and <span class="pkg pkg">sasl2-bin</span> packages, then registering a password in the SASL database for each user that needs authenticating on the SMTP server. This is done with the <span class="command"><strong>saslpasswd2</strong></span> command, which takes several parameters. The <code class="literal">-u</code> option defines the authentication domain, which must match the <code class="literal">smtpd_sasl_local_domain</code> parameter in the Postfix configuration. The <code class="literal">-c</code> option allows creating a user, and <code class="literal">-f</code> allows specifying the file to use if the SASL database needs to be stored at a different location than the default (<code class="filename">/etc/sasldb2</code>).
			</p>
			 
<pre class="screen scale scale">
<code class="computeroutput"># </code><strong class="userinput"><code>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code class="computeroutput">[... type jean's password twice ...]</code></pre>
			 <p>
				Note that the SASL database was created in Postfix's directory. In order to ensure consistency, we also turn <code class="filename">/etc/sasldb2</code> into a symbolic link pointing at the database used by Postfix, with the <span class="command"><strong>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</strong></span> command.
			</p>
			 <p>
				Now we need to configure Postfix to use SASL. First the <code class="literal">postfix</code> user needs to be added to the <code class="literal">sasl</code> group, so that it can access the SASL account database. A few new parameters are also needed to enable SASL, and the <code class="literal">smtpd_recipient_restrictions</code> parameter needs to be configured to allow SASL-authenticated clients to send emails freely.
			</p>
			 <div class="example" id="id-1.14.4.13.7"><a xmlns="" id="id-1.14.4.13.7"/><p class="title"><strong>Ví dụ 11.15. Enabling SASL in <code class="filename">/etc/postfix/main.cf</code></strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre>

			</div></div>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>EXTRA</em></span> Authenticated SMTP client</strong></p></div></div></div> 
			 <p>
				Most email clients are able to authenticate to an SMTP server before sending outgoing messages, and using that feature is a simple matter of configuring the appropriate parameters. If the client in use does not provide that feature, the workaround is to use a local Postfix server and configure it to relay email via the remote SMTP server. In this case, the local Postfix itself will be the client that authenticates with SASL. Here are the required parameters:
			</p>
			 
<pre class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre>
			 <p>
				The <code class="filename">/etc/postfix/sasl_passwd</code> file needs to contain the username and password to use for authenticating on the <code class="literal">mail.falcot.com</code> server. Here is an example:
			</p>
			 
<pre class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre>
			 <p>
				As for all Postfix maps, this file must be turned into <code class="filename">/etc/postfix/sasl_passwd.db</code> with the <span class="command"><strong>postmap</strong></span> command.
			</p>
			 </div>
		</section>

	</section>
	 
	 
	 
	 
	 
	 
	 
</section><footer/></body></html>