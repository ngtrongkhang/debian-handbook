<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>9.10. Backup</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="System boot, Initscripts, SSH, Telnet, Rights, Permissions, Supervision, Inetd, Cron, Backup, Hotplug, PCMCIA, APM, ACPI"/><link rel="prev" href="sect.quotas.html" title="9.9. Quotas"/><link rel="next" href="sect.hotplug.html" title="9.11. Hot Plugging: hotplug"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.backup.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.quotas.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.hotplug.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section class="section" id="sect.backup"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.backup"/>9.10. Backup</h2></div></div></div>
		
		 <p>
			Making backups is one of the main responsibilities of any administrator, but it is a complex subject, involving powerful tools which are often difficult to master.
		</p>
		 <a id="id-1.12.13.3" class="indexterm"></a>
		 <a id="id-1.12.13.4" class="indexterm"></a>
		 <p>
			Many programs exist, such as <span class="command"><strong>amanda</strong></span>, <span class="command"><strong>bacula</strong></span>, <span class="command"><strong>BackupPC</strong></span>. Those are client/server system featuring many options, whose configuration is rather difficult. Some of them provide user-friendly web interfaces to mitigate this. But Debian contains dozens of other backup software covering all possible use cases, as you can easily confirm with <span class="command"><strong>apt-cache search backup</strong></span>.
		</p>
		 <a id="id-1.12.13.6" class="indexterm"></a>
		 <a id="id-1.12.13.7" class="indexterm"></a>
		 <a id="id-1.12.13.8" class="indexterm"></a>
		 <p>
			Rather than detailing some of them, this section will present the thoughts of the Falcot Corp administrators when they defined their backup strategy.
		</p>
		 <p>
			At Falcot Corp, backups have two goals: recovering erroneously deleted files, and quickly restoring any computer (server or desktop) whose hard drive has failed.
		</p>
		 <section class="section" id="id-1.12.13.11"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.12.13.11"/>9.10.1. Backing Up with <span class="command"><strong>rsync</strong></span></h3></div></div></div>
			
			 <p>
				Backups on tape having been deemed too slow and costly, data will be backed up on hard drives on a dedicated server, on which the use of software RAID (see <a class="xref" href="advanced-administration.html#sect.raid-soft" title="12.1.1. Software RAID">Phần 12.1.1, “Software RAID”</a>) will protect the data from hard drive failure. Desktop computers are not backed up individually, but users are advised that their personal account on their department's file server will be backed up. The <span class="command"><strong>rsync</strong></span> command (from the package of the same name) is used daily to back up these different servers.
			</p>
			 <a id="id-1.12.13.11.3" class="indexterm"></a>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>BACK TO BASICS</em></span> The hard link, a second name for the file</strong></p></div></div></div> 
			 <a id="id-1.12.13.11.4.2" class="indexterm"></a>
			 <a id="id-1.12.13.11.4.3" class="indexterm"></a>
			 <p>
				A hard link, as opposed to a symbolic link, cannot be differentiated from the linked file. Creating a hard link is essentially the same as giving an existing file a second name. This is why the deletion of a hard link only removes one of the names associated with the file. As long as another name is still assigned to the file, the data therein remain present on the filesystem. It is interesting to note that, unlike a copy, the hard link does not take up additional space on the hard drive.
			</p>
			 <p>
				A hard link is created with the <span class="command"><strong>ln <em class="replaceable">target</em> <em class="replaceable">link</em></strong></span> command. The <em class="replaceable">link</em> file is then a new name for the <em class="replaceable">target</em> file. Hard links can only be created on the same filesystem, while symbolic links are not subject to this limitation.
			</p>
			 </div> <p>
				The available hard drive space prohibits implementation of a complete daily backup. As such, the <span class="command"><strong>rsync</strong></span> command is preceded by a duplication of the content of the previous backup with hard links, which prevents usage of too much hard drive space. The <span class="command"><strong>rsync</strong></span> process then only replaces files that have been modified since the last backup. With this mechanism a great number of backups can be kept in a small amount of space. Since all backups are immediately available and accessible (for example, in different directories of a given share on the network), you can quickly make comparisons between two given dates.
			</p>
			 <a id="id-1.12.13.11.6" class="indexterm"></a>
			 <a id="id-1.12.13.11.7" class="indexterm"></a>
			 <a id="id-1.12.13.11.8" class="indexterm"></a>
			 <p>
				This backup mechanism is easily implemented with the <span class="command"><strong>dirvish</strong></span> program. It uses a backup storage space (“bank” in its vocabulary) in which it places timestamped copies of sets of backup files (these sets are called “vaults” in the dirvish documentation).
			</p>
			 <p>
				The main configuration is in the <code class="filename">/etc/dirvish/master.conf</code> file. It defines the location of the backup storage space, the list of “vaults” to manage, and default values for expiration of the backups. The rest of the configuration is located in the <code class="filename"><em class="replaceable">bank</em>/<em class="replaceable">vault</em>/dirvish/default.conf</code> files and contains the specific configuration for the corresponding set of files.
			</p>
			 <div class="example" id="example.dirvish-master"><a xmlns="" id="example.dirvish-master"/><p class="title"><strong>Ví dụ 9.3. The <code class="filename">/etc/dirvish/master.conf</code> file</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">bank:
    /backup
exclude:
    lost+found/
    core
    *~
Runall:
    root    22:00
expire-default: +15 days
expire-rule:
#   MIN HR    DOM MON       DOW  STRFTIME_FMT
    *   *     *   *         1    +3 months
    *   *     1-7 *         1    +1 year
    *   *     1-7 1,4,7,10  1
</pre>

			</div></div>
			 <p>
				The <code class="literal">bank</code> setting indicates the directory in which the backups are stored. The <code class="literal">exclude</code> setting allows you to indicate files (or file types) to exclude from the backup. The <code class="literal">Runall</code> is a list of file sets to backup with a time-stamp for each set, which allows you to assign the correct date to the copy, in case the backup is not triggered at precisely the assigned time. You have to indicate a time just before the actual execution time (which is, by default, 10:04 pm in Debian, according to <code class="filename">/etc/cron.d/dirvish</code>). Finally, the <code class="literal">expire-default</code> and <code class="literal">expire-rule</code> settings define the expiration policy for backups. The above example keeps forever backups that are generated on the first Sunday of each quarter, deletes after one year those from the first Sunday of each month, and after 3 months those from other Sundays. Other daily backups are kept for 15 days. The order of the rules does matter, Dirvish uses the last matching rule, or the <code class="literal">expire-default</code> one if no other <code class="literal">expire-rule</code> matches.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>IN PRACTICE</em></span> Scheduled expiration</strong></p></div></div></div> 
			 <p>
				The expiration rules are not used by <span class="command"><strong>dirvish-expire</strong></span> to do its job. In reality, the expiration rules are applied when creating a new backup copy to define the expiration date associated with that copy. <span class="command"><strong>dirvish-expire</strong></span> simply peruses the stored copies and deletes those for which the expiration date has passed.
			</p>
			 </div> <div class="example" id="example.dirvish-vault"><a xmlns="" id="example.dirvish-vault"/><p class="title"><strong>Ví dụ 9.4. The <code class="filename">/backup/root/dirvish/default.conf</code> file</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">client: rivendell.falcot.com
tree: /
xdev: 1
index: gzip
image-default: %Y%m%d
exclude:
    /var/cache/apt/archives/*.deb
    /var/cache/man/**
    /tmp/**
    /var/tmp/**
    *.bak
</pre>

			</div></div>
			 <p>
				The above example specifies the set of files to back up: these are files on the machine <span class="emphasis"><em>rivendell.falcot.com</em></span> (for local data backup, simply specify the name of the local machine as indicated by <span class="command"><strong>hostname</strong></span>), especially those in the root tree (<code class="literal">tree: /</code>), except those listed in <code class="literal">exclude</code>. The backup will be limited to the contents of one filesystem (<code class="literal">xdev: 1</code>). It will not include files from other mount points. An index of saved files will be generated (<code class="literal">index: gzip</code>), and the image will be named according to the current date (<code class="literal">image-default: %Y%m%d</code>).
			</p>
			 <p>
				There are many options available, all documented in the <span class="citerefentry"><span class="refentrytitle">dirvish.conf</span>
				(5)</span> manual page. Once these configuration files are setup, you have to initialize each file set with the <span class="command"><strong>dirvish --vault <em class="replaceable">vault</em> --init</strong></span> command. From there on the daily invocation of <span class="command"><strong>dirvish-runall</strong></span> will automatically create a new backup copy just after having deleted those that expired.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>IN PRACTICE</em></span> Remote backup over SSH</strong></p></div></div></div> 
			 <p>
				When dirvish needs to save data to a remote machine, it will use <span class="command"><strong>ssh</strong></span> to connect to it, and will start <span class="command"><strong>rsync</strong></span> as a server. This requires the root user to be able to automatically connect to it. The use of an SSH authentication key allows precisely that (see <a class="xref" href="sect.remote-login.html#sect.ssh-key-based-auth" title="9.2.1.1. Key-Based Authentication">Phần 9.2.1.1, “Key-Based Authentication”</a>).
			</p>
			 </div>
		</section>
		 <section class="section" id="id-1.12.13.12"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.12.13.12"/>9.10.2. Restoring Machines without Backups</h3></div></div></div>
			
			 <p>
				Desktop computers, which are not backed up, will be easy to reinstall from custom DVD-ROMs prepared with <span class="emphasis"><em>Simple-CDD</em></span> (see <a class="xref" href="sect.automated-installation.html#sect.simple-cdd" title="12.3.3. Simple-CDD: The All-In-One Solution">Phần 12.3.3, “Simple-CDD: The All-In-One Solution”</a>). Since this performs an installation from scratch, it loses any customization that can have been made after the initial installation. This is fine since the systems are all hooked to a central LDAP directory for accounts and most desktop applications are preconfigured thanks to dconf (see <a class="xref" href="sect.graphical-desktops.html#sect.gnome-desktop" title="13.3.1. GNOME">Phần 13.3.1, “GNOME”</a> for more information about this).
			</p>
			 <p>
				The Falcot Corp administrators are aware of the limits in their backup policy. Since they can't protect the backup server as well as a tape in a fireproof safe, they have installed it in a separate room so that a disaster such as a fire in the server room won't destroy backups along with everything else. Furthermore, they do an incremental backup on DVD-ROM once per week — only files that have been modified since the last backup are included.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>GOING FURTHER</em></span> Backing up SQL and LDAP services</strong></p></div></div></div> 
			 <p>
				Many services (such as SQL or LDAP databases) cannot be backed up by simply copying their files (unless they are properly interrupted during creation of the backups, which is frequently problematic, since they are intended to be available at all times). As such, it is necessary to use an “export” mechanism to create a “data dump” that can be safely backed up. These are often quite large, but they compress well. To reduce the storage space required, you will only store a complete text file per week, and a <span class="command"><strong>diff</strong></span> each day, which is created with a command of the type <span class="command"><strong>diff <em class="replaceable">file_from_yesterday</em> <em class="replaceable">file_from_today</em></strong></span>. The <span class="command"><strong>xdelta</strong></span> program produces incremental differences from binary dumps.
			</p>
			 <a id="id-1.12.13.12.4.3" class="indexterm"></a>
			 <a id="id-1.12.13.12.4.4" class="indexterm"></a>
			 <a id="id-1.12.13.12.4.5" class="indexterm"></a>
			 </div> <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CULTURE</em></span> <span class="emphasis"><em>TAR</em></span>, the standard for tape backups</strong></p></div></div></div> 
			 <a id="id-1.12.13.12.5.2" class="indexterm"></a>
			 <a id="id-1.12.13.12.5.3" class="indexterm"></a>
			 <a id="id-1.12.13.12.5.4" class="indexterm"></a>
			 <p>
				Historically, the simplest means of making a backup on Unix was to store a <span class="emphasis"><em>TAR</em></span> archive on a tape. The <span class="command"><strong>tar</strong></span> command even got its name from “Tape ARchive”.
			</p>
			 </div>
		</section>

	</section><footer/></body></html>