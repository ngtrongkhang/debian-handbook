<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>11.4. NFS File Server</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP"/><link rel="prev" href="sect.ftp-file-server.html" title="11.3. Máy phục vụ Tập tin FTP"/><link rel="next" href="sect.windows-file-server-with-samba.html" title="11.5. Setting Up Windows Shares with Samba"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.nfs-file-server.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.ftp-file-server.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.windows-file-server-with-samba.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section class="section" id="sect.nfs-file-server"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.nfs-file-server"/>11.4. NFS File Server</h2></div></div></div>
		
		 <p>
			NFS (<span class="emphasis"><em>Network File System</em></span>) is a protocol allowing remote access to a filesystem through the network. All Unix systems can work with this protocol; when Windows systems are involved, Samba must be used instead.
		</p>
		 <a id="id-1.14.7.3" class="indexterm"></a>
		 <a id="id-1.14.7.4" class="indexterm"></a>
		 <a id="id-1.14.7.5" class="indexterm"></a>
		 <a id="id-1.14.7.6" class="indexterm"></a>
		 <a id="id-1.14.7.7" class="indexterm"></a>
		 <p>
			NFS is a very useful tool but, historically, it has suffered from many limitations, most of which have been addressed with version 4 of the protocol. The downside is that the latest version of NFS is harder to configure when you want to make use of basic security features such as authentication and encryption since it relies on Kerberos for those parts. And without those, the NFS protocol must be restricted to a trusted local network since data goes over the network unencrypted (a <span class="emphasis"><em>sniffer</em></span> can intercept it) and access rights are granted based on the client's IP address (which can be spoofed).
		</p>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>DOCUMENTATION</em></span> NFS HOWTO</strong></p></div></div></div> 
		 <p>
			Good documentation to deploy NFSv4 is rather scarce. Here are some pointers with content of varying quality but that should at least give some hints on what should be done. <a class="ulink" href="https://help.ubuntu.com/community/NFSv4Howto">https://help.ubuntu.com/community/NFSv4Howto</a> <a class="ulink" href="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration">http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration</a>
		</p>
		 </div> <section class="section" id="id-1.14.7.10"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.7.10"/>11.4.1. Securing NFS</h3></div></div></div>
			
			 <a id="id-1.14.7.10.2" class="indexterm"></a>
			 <p>
				If you don't use the Kerberos-based security features, it is vital to ensure that only the machines allowed to use NFS can connect to the various required RPC servers, because the basic protocol trusts the data received from the network. The firewall must also block <span class="emphasis"><em>IP spoofing</em></span> so as to prevent an outside machine from acting as an inside one, and access to the appropriate ports must be restricted to the machines meant to access the NFS shares.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>BACK TO BASICS</em></span> RPC</strong></p></div></div></div> 
			 <p>
				RPC (<span class="emphasis"><em>Remote Procedure Call</em></span>) is a Unix standard for remote services. NFS is one such service.
			</p>
			 <a id="id-1.14.7.10.4.3" class="indexterm"></a>
			 <a id="id-1.14.7.10.4.4" class="indexterm"></a>
			 <p>
				RPC services register to a directory known as the <span class="emphasis"><em>portmapper</em></span>. A client wishing to perform an NFS query first addresses the <span class="emphasis"><em>portmapper</em></span> (on port 111, either TCP or UDP), and asks for the NFS server; the reply usually mentions port 2049 (the default for NFS). Not all RPC services necessarily use a fixed port.
			</p>
			 </div> <p>
				Older versions of the protocol required other RPC services which used dynamically assigned ports. Fortunately, with NFS version 4, only port 2049 (for NFS) and 111 (for the portmapper) are needed and they are thus easy to firewall.
			</p>
			 <a id="id-1.14.7.10.6" class="indexterm"></a>

		</section>
		 <section class="section" id="id-1.14.7.11"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.7.11"/>11.4.2. NFS Server</h3></div></div></div>
			
			 <p>
				The NFS server is part of the Linux kernel; in kernels provided by Debian it is built as a kernel module. If the NFS server is to be run automatically on boot, the <span class="pkg pkg">nfs-kernel-server</span> package should be installed; it contains the relevant start-up scripts.
			</p>
			 <p>
				The NFS server configuration file, <code class="filename">/etc/exports</code>, lists the directories that are made available over the network (<span class="emphasis"><em>exported</em></span>). For each NFS share, only the given list of machines is granted access. More fine-grained access control can be obtained with a few options. The syntax for this file is quite simple:
			</p>
			 <a id="id-1.14.7.11.4" class="indexterm"></a>
			 <a id="id-1.14.7.11.5" class="indexterm"></a>
			 
<pre class="programlisting">
/directory/to/share machine1(option1,option2,...) machine2(...) ...
</pre>
			 <p>
				Note that with NFSv4, all exported directories must be part of a single hierarchy and that the root directory of that hierarchy must be exported and identified with the option <code class="literal">fsid=0</code> or <code class="literal">fsid=root</code>.
			</p>
			 <p>
				Each machine can be identified either by its DNS name or its IP address. Whole sets of machines can also be specified using either a syntax such as <code class="literal">*.falcot.com</code> or an IP address range such as <code class="literal">192.168.0.0/255.255.255.0</code> or <code class="literal">192.168.0.0/24</code>.
			</p>
			 <p>
				Directories are made available as read-only by default (or with the <code class="literal">ro</code> option). The <code class="literal">rw</code> option allows read-write access. NFS clients typically connect from a port restricted to root (in other words, below 1024); this restriction can be lifted by the <code class="literal">insecure</code> option (the <code class="literal">secure</code> option is implicit, but it can be made explicit if needed for clarity).
			</p>
			 <a id="id-1.14.7.11.10" class="indexterm"></a>
			 <p>
				By default, the server only answers an NFS query when the current disk operation is complete (<code class="literal">sync</code> option); this can be disabled with the <code class="literal">async</code> option. Asynchronous writes increase performance a bit, but they decrease reliability since there is a data loss risk in case of the server crashing between the acknowledgment of the write and the actual write on disk. Since the default value changed recently (as compared to the historical value of NFS), an explicit setting is recommended.
			</p>
			 <p>
				In order to not give root access to the filesystem to any NFS client, all queries appearing to come from a root user are considered by the server as coming from the <code class="literal">nobody</code> user. This behavior corresponds to the <code class="literal">root_squash</code> option, and is enabled by default. The <code class="literal">no_root_squash</code> option, which disables this behavior, is risky and should only be used in controlled environments. The <code class="literal">anonuid=<em class="replaceable">uid</em></code> and <code class="literal">anongid=<em class="replaceable">gid</em></code> options allow specifying another fake user to be used instead of UID/GID 65534 (which corresponds to user <code class="literal">nobody</code> and group <code class="literal">nogroup</code>).
			</p>
			 <p>
				With NFSv4, you can add a <code class="literal">sec</code> option to indicate the security level that you want: <code class="literal">sec=sys</code> is the default with no special security features, <code class="literal">sec=krb5</code> enables authentication only, <code class="literal">sec=krb5i</code> adds integrity protection, and <code class="literal">sec=krb5p</code> is the most complete level which includes privacy protection (with data encryption). For this to work you need a working Kerberos setup (that service is not covered by this book).
			</p>
			 <p>
				Other options are available; they are documented in the <span class="citerefentry"><span class="refentrytitle">exports</span>
				 (5)</span> manual page.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CAUTION</em></span> First installation</strong></p></div></div></div> 
			 <p>
				The <code class="filename">/etc/init.d/nfs-kernel-server</code> boot script only starts the server if the <code class="filename">/etc/exports</code> lists one or more valid NFS shares. On initial configuration, once this file has been edited to contain valid entries, the NFS server must therefore be started with the following command:
			</p>
			 
<pre class="screen">
<code class="computeroutput"># </code><strong class="userinput"><code>service nfs-kernel-server start</code></strong></pre>
			 </div>
		</section>
		 <section class="section" id="id-1.14.7.12"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.7.12"/>11.4.3. NFS Client</h3></div></div></div>
			
			 <a id="id-1.14.7.12.2" class="indexterm"></a>
			 <a id="id-1.14.7.12.3" class="indexterm"></a>
			 <p>
				As with other filesystems, integrating an NFS share into the system hierarchy requires mounting. Since this filesystem has its peculiarities, a few adjustments were required in the syntaxes of the <span class="command"><strong>mount</strong></span> command and the <code class="filename">/etc/fstab</code> file.
			</p>
			 <div class="example" id="id-1.14.7.12.5"><a xmlns="" id="id-1.14.7.12.5"/><p class="title"><strong>Ví dụ 11.22. Manually mounting with the <span class="command">mount</span> command</strong></p><div class="example-contents">
				
				 
<pre class="screen">
          <code class="computeroutput"># </code><strong class="userinput"><code>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</code></strong></pre>

			</div></div>
			 <div class="example" id="id-1.14.7.12.6"><a xmlns="" id="id-1.14.7.12.6"/><p class="title"><strong>Ví dụ 11.23. NFS entry in the <code class="filename">/etc/fstab</code> file</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0
</pre>

			</div></div>
			 <p>
				The entry described above mounts, at system startup, the <code class="filename">/shared/</code> NFS directory from the <code class="literal">arrakis</code> server into the local <code class="filename">/srv/shared/</code> directory. Read-write access is requested (hence the <code class="literal">rw</code> parameter). The <code class="literal">nosuid</code> option is a protection measure that wipes any <code class="literal">setuid</code> or <code class="literal">setgid</code> bit from programs stored on the share. If the NFS share is only meant to store documents, another recommended option is <code class="literal">noexec</code>, which prevents executing programs stored on the share. Note that on the server, the <code class="filename">shared</code> directory is below the NFSv4 root export (for example <code class="filename">/export/shared</code>), it is not a top-level directory.
			</p>
			 <p>
				The <span class="citerefentry"><span class="refentrytitle">nfs</span>
				 (5)</span> manual page describes all the options in some detail.
			</p>

		</section>

	</section><footer/></body></html>