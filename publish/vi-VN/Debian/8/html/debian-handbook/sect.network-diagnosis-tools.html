<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>10.8. Network Diagnosis Tools</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Network, Gateway, TCP/IP, IPv6, DNS, Bind, DHCP, QoS"/><link rel="prev" href="sect.dhcp.html" title="10.7. DHCP"/><link rel="next" href="network-services.html" title="Chương 11. Những dịch vụ mạng: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.network-diagnosis-tools.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.dhcp.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="network-services.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section class="section" id="sect.network-diagnosis-tools"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.network-diagnosis-tools"/>10.8. Network Diagnosis Tools</h2></div></div></div>
		
		 <p>
			When a network application does not run as expected, it is important to be able to look under the hood. Even when everything seems to run smoothly, running a network diagnosis can help ensure everything is working as it should. Several diagnosis tools exists for this purpose; each one operates on a different level.
		</p>
		 <section class="section" id="sect.netstat"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.netstat"/>10.8.1. Local Diagnosis: <span class="command"><strong>netstat</strong></span></h3></div></div></div>
			
			 <a id="id-1.13.11.3.2" class="indexterm"></a>
			 <p>
				Let's first mention the <span class="command"><strong>netstat</strong></span> command (in the <span class="pkg pkg">net-tools</span> package); it displays an instant summary of a machine's network activity. When invoked with no argument, this command lists all open connections; this list can be very verbose since it includes many Unix-domain sockets (widely used by daemons) which do not involve the network at all (for example, <code class="literal">dbus</code> communication, <code class="literal">X11</code> traffic, and communications between virtual filesystems and the desktop).
			</p>
			 <p>
				Common invocations therefore use options that alter <span class="command"><strong>netstat</strong></span>'s behavior. The most frequently used options include:
			</p>
			 <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<p>
						<code class="literal">-t</code>, which filters the results to only include TCP connections;
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">-u</code>, which works similarly for UDP connections; these options are not mutually exclusive, and one of them is enough to stop displaying Unix-domain connections;
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">-a</code>, to also list listening sockets (waiting for incoming connections);
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">-n</code>, to display the results numerically: IP addresses (no DNS resolution), port numbers (no aliases as defined in <code class="filename">/etc/services</code>) and user ids (no login names);
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">-p</code>, to list the processes involved; this option is only useful when <span class="command"><strong>netstat</strong></span> is run as root, since normal users will only see their own processes;
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">-c</code>, to continuously refresh the list of connections.
					</p>

				</li></ul></div>
			 <p>
				Other options, documented in the <span class="citerefentry"><span class="refentrytitle">netstat</span>
				 (8)</span> manual page, provide an even finer control over the displayed results. In practice, the first five options are so often used together that systems and network administrators practically acquired <span class="command"><strong>netstat -tupan</strong></span> as a reflex. Typical results, on a lightly loaded machine, may look like the following:
			</p>
			 
<pre class="screen scale scale">
<code class="computeroutput"># </code><strong class="userinput"><code>netstat -tupan</code></strong>
<code class="computeroutput">Active Internet connections (servers and established) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:111 0.0.0.0:* LISTEN 397/rpcbind tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 431/sshd tcp 0 0 0.0.0.0:36568 0.0.0.0:* LISTEN 407/rpc.statd tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN 762/exim4 tcp 0 272 192.168.1.242:22 192.168.1.129:44452 ESTABLISHED 1172/sshd: roland [ tcp6 0 0 :::111 :::* LISTEN 397/rpcbind tcp6 0 0 :::22 :::* LISTEN 431/sshd tcp6 0 0 ::1:25 :::* LISTEN 762/exim4 tcp6 0 0 :::35210 :::* LISTEN 407/rpc.statd udp 0 0 0.0.0.0:39376 0.0.0.0:* 916/dhclient udp 0 0 0.0.0.0:996 0.0.0.0:* 397/rpcbind udp 0 0 127.0.0.1:1007 0.0.0.0:* 407/rpc.statd udp 0 0 0.0.0.0:68 0.0.0.0:* 916/dhclient udp 0 0 0.0.0.0:48720 0.0.0.0:* 451/avahi-daemon: r udp 0 0 0.0.0.0:111 0.0.0.0:* 397/rpcbind udp 0 0 192.168.1.242:123 0.0.0.0:* 539/ntpd udp 0 0 127.0.0.1:123 0.0.0.0:* 539/ntpd udp 0 0 0.0.0.0:123 0.0.0.0:* 539/ntpd udp 0 0 0.0.0.0:5353 0.0.0.0:* 451/avahi-daemon: r udp 0 0 0.0.0.0:39172 0.0.0.0:* 407/rpc.statd udp6 0 0 :::996 :::* 397/rpcbind udp6 0 0 :::34277 :::* 407/rpc.statd udp6 0 0 :::54852 :::* 916/dhclient udp6 0 0 :::111 :::* 397/rpcbind udp6 0 0 :::38007 :::* 451/avahi-daemon: r udp6 0 0 fe80::5054:ff:fe99::123 :::* 539/ntpd udp6 0 0 2001:bc8:3a7e:210:a:123 :::* 539/ntpd udp6 0 0 2001:bc8:3a7e:210:5:123 :::* 539/ntpd udp6 0 0 ::1:123 :::* 539/ntpd udp6 0 0 :::123 :::* 539/ntpd udp6 0 0 :::5353 :::* 451/avahi-daemon: r </code></pre>
			 <p>
				As expected, this lists established connections, two SSH connections in this case, and applications waiting for incoming connections (listed as <code class="literal">LISTEN</code>), notably the Exim4 email server listening on port 25.
			</p>

		</section>
		 <section class="section" id="sect.nmap"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.nmap"/>10.8.2. Remote Diagnosis: <span class="command"><strong>nmap</strong></span></h3></div></div></div>
			
			 <a id="id-1.13.11.4.2" class="indexterm"></a>
			 <p>
				<span class="command"><strong>nmap</strong></span> (in the similarly-named package) is, in a way, the remote equivalent for <span class="command"><strong>netstat</strong></span>. It can scan a set of “well-known” ports for one or several remote servers, and list the ports where an application is found to answer to incoming connections. Furthermore, <span class="command"><strong>nmap</strong></span> is able to identify some of these applications, sometimes even their version number. The counterpart of this tool is that, since it runs remotely, it cannot provide information on processes or users; however, it can operate on several targets at once.
			</p>
			 <p>
				A typical <span class="command"><strong>nmap</strong></span> invocation only uses the <code class="literal">-A</code> option (so that <span class="command"><strong>nmap</strong></span> attempts to identify the versions of the server software it finds) followed by one or more IP addresses or DNS names of machines to scan. Again, many more options exist to finely control the behavior of <span class="command"><strong>nmap</strong></span>; please refer to the documentation in the <span class="citerefentry"> <span class="refentrytitle">nmap</span>
				 (1) </span> manual page.
			</p>
			 
<pre class="screen scale scale" width="80">
<code class="computeroutput"># </code><strong class="userinput"><code>nmap mirtuel</code></strong>
<code class="computeroutput"> Starting Nmap 6.47 ( http://nmap.org ) at 2015-03-09 16:46 CET Nmap scan report for mirtuel (192.168.1.242) Host is up (0.000013s latency). rDNS record for 192.168.1.242: mirtuel.internal.placard.fr.eu.org Not shown: 998 closed ports PORT STATE SERVICE 22/tcp open ssh 111/tcp open rpcbind Nmap done: 1 IP address (1 host up) scanned in 2.41 seconds # </code><strong class="userinput"><code>nmap -A localhost</code></strong>
<code class="computeroutput"> Starting Nmap 6.47 ( http://nmap.org ) at 2015-03-09 16:46 CET Nmap scan report for localhost (127.0.0.1) Host is up (0.000013s latency). Other addresses for localhost (not scanned): 127.0.0.1 Not shown: 997 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.7p1 Debian 3 (protocol 2.0) |_ssh-hostkey: ERROR: Script execution failed (use -d to debug) 25/tcp open smtp Exim smtpd 4.84 | smtp-commands: mirtuel Hello localhost [127.0.0.1], SIZE 52428800, 8BITMIME, PIPELINING, HELP, |_ Commands supported: AUTH HELO EHLO MAIL RCPT DATA NOOP QUIT RSET HELP 111/tcp open rpcbind 2-4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/udp rpcbind | 100024 1 36568/tcp status |_ 100024 1 39172/udp status Device type: general purpose Running: Linux 3.X OS CPE: cpe:/o:linux:linux_kernel:3 OS details: Linux 3.7 - 3.15 Network Distance: 0 hops Service Info: Host: mirtuel; OS: Linux; CPE: cpe:/o:linux:linux_kernel OS and Service detection performed. Please report any incorrect results at http://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 11.54 seconds </code></pre>
			 <p>
				As expected, the SSH and Exim4 applications are listed. Note that not all applications listen on all IP addresses; since Exim4 is only accessible on the <code class="literal">lo</code> loopback interface, it only appears during an analysis of <code class="literal">localhost</code> and not when scanning <code class="literal">mirtuel</code> (which maps to the <code class="literal">eth0</code> interface on the same machine).
			</p>

		</section>
		 <section class="section" id="sect.sniffers"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.sniffers"/>10.8.3. Sniffers: <span class="command"><strong>tcpdump</strong></span> and <span class="command"><strong>wireshark</strong></span></h3></div></div></div>
			
			 <p>
				Sometimes, one needs to look at what actually goes on the wire, packet by packet. These cases call for a “frame analyzer”, more widely known as a <span class="emphasis"><em>sniffer</em></span>. Such a tool observes all the packets that reach a given network interface, and displays them in a user-friendly way.
			</p>
			 <a id="id-1.13.11.5.3" class="indexterm"></a>
			 <p>
				The venerable tool in this domain is <span class="command"><strong>tcpdump</strong></span>, available as a standard tool on a wide range of platforms. It allows many kinds of network traffic capture, but the representation of this traffic stays rather obscure. We will therefore not describe it in further detail.
			</p>
			 <a id="id-1.13.11.5.5" class="indexterm"></a>
			 <p>
				A more recent (and more modern) tool, <span class="command"><strong>wireshark</strong></span> (in the <span class="pkg pkg">wireshark</span> package), has become the new reference in network traffic analysis due to its many decoding modules that allow for a simplified analysis of the captured packets. The packets are displayed graphically with an organization based on the protocol layers. This allows a user to visualize all protocols involved in a packet. For example, given a packet containing an HTTP request, <span class="command"><strong>wireshark</strong></span> displays, separately, the information concerning the physical layer, the Ethernet layer, the IP packet information, the TCP connection parameters, and finally the HTTP request itself.
			</p>
			 <div class="figure" id="figure.wireshark"><a id="figure.wireshark"/><p class="title"><strong>Hình 10.1. The <span class="command">wireshark</span> network traffic analyzer</strong></p><div class="figure-contents">
				
				 <div class="mediaobject"><img src="images/wireshark.png" alt="The wireshark network traffic analyzer"/></div>

			</div></div>
			 <p>
				In our example, the packets traveling over SSH are filtered out (with the <code class="literal">!tcp.port == 22</code> filter). The packet currently displayed was developed at the HTTP layer.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TIP</em></span> <span class="command"><strong>wireshark</strong></span> with no graphical interface: <span class="command"><strong>tshark</strong></span></strong></p></div></div></div> 
			 <a id="id-1.13.11.5.9.2" class="indexterm"></a>
			 <p>
				When one cannot run a graphical interface, or does not wish to do so for whatever reason, a text-only version of <span class="command"><strong>wireshark</strong></span> also exists under the name <span class="command"><strong>tshark</strong></span> (in a separate <span class="pkg pkg">tshark</span> package). Most of the capture and decoding features are still available, but the lack of a graphical interface necessarily limits the interactions with the program (filtering packets after they've been captured, tracking of a given TCP connection, and so on). It can still be used as a first approach. If further manipulations are intended and require the graphical interface, the packets can be saved to a file and this file can be loaded into a graphical <span class="command"><strong>wireshark</strong></span> running on another machine.
			</p>
			 </div>
		</section>

	</section><footer/></body></html>