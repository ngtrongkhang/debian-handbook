<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>8.10. Compiling a Kernel</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Cấu hình, Nội địa hoá, Bản địa, Mạng, Độ phân giải tên, Người sử dụng, Các nhóm, Tài khoản, Thông dịch bằng dòng lệnh, Shell, In, Bộ tải khởi động, Biên dịch hạt nhân"/><link rel="prev" href="sect.config-misc.html" title="8.9. Other Configurations: Time Synchronization, Logs, Sharing Access…"/><link rel="next" href="sect.kernel-installation.html" title="8.11. Installing a Kernel"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.kernel-compilation.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.config-misc.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.kernel-installation.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section class="section" id="sect.kernel-compilation"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.kernel-compilation"/>8.10. Compiling a Kernel</h2></div></div></div>
		
		 <a id="id-1.11.14.2" class="indexterm"></a>
		 <a id="id-1.11.14.3" class="indexterm"></a>
		 <p>
			The kernels provided by Debian include the largest possible number of features, as well as the maximum of drivers, in order to cover the broadest spectrum of existing hardware configurations. This is why some users prefer to recompile the kernel in order to only include what they specifically need. There are two reasons for this choice. First, it may be to optimize memory consumption, since the kernel code, even if it is never used, occupies memory for nothing (and never “goes down” on the swap space, since it is actual RAM that it uses), which can decrease overall system performance. A locally compiled kernel can also limit the risk of security problems since only a fraction of the kernel code is compiled and run.
		</p>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>NOTE</em></span> Security updates</strong></p></div></div></div> 
		 <p>
			If you choose to compile your own kernel, you must accept the consequences: Debian cannot ensure security updates for your custom kernel. By keeping the kernel provided by Debian, you benefit from updates prepared by the Debian Project's security team.
		</p>
		 </div> <p>
			Recompilation of the kernel is also necessary if you want to use certain features that are only available as patches (and not included in the standard kernel version).
		</p>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>GOING FURTHER</em></span> The Debian Kernel Handbook</strong></p></div></div></div> 
		 <a id="id-1.11.14.7.2" class="indexterm"></a>
		 <p>
			The Debian kernel teams maintains the “Debian Kernel Handbook” (also available in the <span class="pkg pkg">debian-kernel-handbook</span> package) with comprehensive documentation about most kernel related tasks and about how official Debian kernel packages are handled. This is the first place you should look into if you need more information than what is provided in this section. <a class="ulink" href="http://kernel-handbook.alioth.debian.org">http://kernel-handbook.alioth.debian.org</a>
		</p>
		 </div> <section class="section" id="sect.kernel-compilation-prerequisites"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.kernel-compilation-prerequisites"/>8.10.1. Introduction and Prerequisites</h3></div></div></div>
			
			 <p>
				Unsurprisingly Debian manages the kernel in the form of a package, which is not how kernels have traditionally been compiled and installed. Since the kernel remains under the control of the packaging system, it can then be removed cleanly, or deployed on several machines. Furthermore, the scripts associated with these packages automate the interaction with the bootloader and the initrd generator.
			</p>
			 <p>
				The upstream Linux sources contain everything needed to build a Debian package of the kernel. But you still need to install <span class="pkg pkg">build-essential</span> to ensure that you have the tools required to build a Debian package. Furthermore, the configuration step for the kernel requires the <span class="pkg pkg">libncurses5-dev</span> package. Finally, the <span class="pkg pkg">fakeroot</span> package will enable creation of the Debian package without using administrator's rights.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CULTURE</em></span> The good old days of <span class="pkg pkg">kernel-package</span></strong></p></div></div></div> 
			 <a id="id-1.11.14.8.4.2" class="indexterm"></a>
			 <p>
				Before the Linux build system gained the ability to build proper Debian packages, the recommended way to build such packages was to use <span class="command"><strong>make-kpkg</strong></span> from the <span class="pkg pkg">kernel-package</span> package.
			</p>
			 </div>
		</section>
		 <section class="section" id="sect.kernel-sources"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.kernel-sources"/>8.10.2. Getting the Sources</h3></div></div></div>
			
			 <a id="id-1.11.14.9.2" class="indexterm"></a>
			 <a id="id-1.11.14.9.3" class="indexterm"></a>
			 <a id="id-1.11.14.9.4" class="indexterm"></a>
			 <p>
				Like anything that can be useful on a Debian system, the Linux kernel sources are available in a package. To retrieve them, just install the <span class="pkg pkg">linux-source-<em class="replaceable">version</em></span> package. The <span class="command"><strong>apt-cache search ^linux-source</strong></span> command lists the various kernel versions packaged by Debian. The latest version is available in the <span class="distribution distribution">Unstable</span> distribution: you can retrieve them without much risk (especially if your APT is configured according to the instructions of <a class="xref" href="sect.apt-get.html#sect.apt-mix-distros" title="6.2.6. Làm việc với một số bản phân phối">Phần 6.2.6, “Làm việc với một số bản phân phối”</a>). Note that the source code contained in these packages does not correspond precisely with that published by Linus Torvalds and the kernel developers; like all distributions, Debian applies a number of patches, which might (or might not) find their way into the upstream version of Linux. These modifications include backports of fixes/features/drivers from newer kernel versions, new features not yet (entirely) merged in the upstream Linux tree, and sometimes even Debian specific changes.
			</p>
			 <p>
				The remainder of this section focuses on the 3.16 version of the Linux kernel, but the examples can, of course, be adapted to the particular version of the kernel that you want.
			</p>
			 <p>
				We assume the <span class="pkg pkg">linux-source-3.16</span> package has been installed. It contains <code class="filename">/usr/src/linux-source-3.16.tar.xz</code>, a compressed archive of the kernel sources. You must extract these files in a new directory (not directly under <code class="filename">/usr/src/</code>, since there is no need for special permissions to compile a Linux kernel): <code class="filename">~/kernel/</code> is appropriate.
			</p>
			 
<pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>mkdir ~/kernel; cd ~/kernel</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>tar -xaf /usr/src/linux-source-3.16.tar.xz</code></strong></pre>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CULTURE</em></span> Location of kernel sources</strong></p></div></div></div> 
			 <p>
				Traditionally, Linux kernel sources would be placed in <code class="filename">/usr/src/linux/</code> thus requiring root permissions for compilation. However, working with administrator rights should be avoided when not needed. There is a <code class="literal">src</code> group that allows members to work in this directory, but working in <code class="filename">/usr/src/</code> should be avoided nevertheless. By keeping the kernel sources in a personal directory, you get security on all counts: no files in <code class="filename">/usr/</code> unknown to the packaging system, and no risk of misleading programs that read <code class="filename">/usr/src/linux</code> when trying to gather information on the used kernel.
			</p>
			 </div>
		</section>
		 <section class="section" id="sect.config-kernel"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.config-kernel"/>8.10.3. Configuring the Kernel</h3></div></div></div>
			
			 <a id="id-1.11.14.10.2" class="indexterm"></a>
			 <a id="id-1.11.14.10.3" class="indexterm"></a>
			 <a id="id-1.11.14.10.4" class="indexterm"></a>
			 <p>
				The next step consists of configuring the kernel according to your needs. The exact procedure depends on the goals.
			</p>
			 <p>
				When recompiling a more recent version of the kernel (possibly with an additional patch), the configuration will most likely be kept as close as possible to that proposed by Debian. In this case, and rather than reconfiguring everything from scratch, it is sufficient to copy the <code class="filename">/boot/config-<em class="replaceable">version</em></code> file (the version is that of the kernel currently used, which can be found with the <span class="command"><strong>uname -r</strong></span> command) into a <code class="filename">.config</code> file in the directory containing the kernel sources.
			</p>
			 
<pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>cp /boot/config-3.16.0-4-amd64 ~/kernel/linux-source-3.16/.config</code></strong></pre>
			 <p>
				Unless you need to change the configuration, you can stop here and skip to <a class="xref" href="sect.kernel-compilation.html#sect.kernel-build" title="8.10.4. Compiling and Building the Package">Phần 8.10.4, “Compiling and Building the Package”</a>. If you need to change it, on the other hand, or if you decide to reconfigure everything from scratch, you must take the time to configure your kernel. There are various dedicated interfaces in the kernel source directory that can be used by calling the <span class="command"><strong>make <em class="replaceable">target</em></strong></span> command, where <em class="replaceable">target</em> is one of the values described below.
			</p>
			 <p>
				<span class="command"><strong>make menuconfig</strong></span> compiles and executes a text-mode interface (this is where the <span class="pkg pkg">libncurses5-dev</span> package is required) which allows navigating the options available in a hierarchical structure. Pressing the <span class="keycap"><strong>Space</strong></span> key changes the value of the selected option, and <span class="keycap"><strong>Enter</strong></span> validates the button selected at the bottom of the screen; <span class="guibutton">Select</span> returns to the selected sub-menu; <span class="guibutton">Exit</span> closes the current screen and moves back up in the hierarchy; <span class="guibutton">Help</span> will display more detailed information on the role of the selected option. The arrow keys allow moving within the list of options and buttons. To exit the configuration program, choose <span class="guibutton">Exit</span> from the main menu. The program then offers to save the changes you've made; accept if you are satisfied with your choices.
			</p>
			 <p>
				Other interfaces have similar features, but they work within more modern graphical interfaces; such as <span class="command"><strong>make xconfig</strong></span> which uses a Qt graphical interface, and <span class="command"><strong>make gconfig</strong></span> which uses GTK+. The former requires <span class="pkg pkg">libqt4-dev</span>, while the latter depends on <span class="pkg pkg">libglade2-dev</span> and <span class="pkg pkg">libgtk2.0-dev</span>.
			</p>
			 <p>
				When using one of those configuration interfaces, it is always a good idea to start from a reasonable default configuration. The kernel provides such configurations in <code class="filename">arch/<em class="replaceable">arch</em>/configs/*_defconfig</code> and you can put your selected configuration in place with a command like <span class="command"><strong>make x86_64_defconfig</strong></span> (in the case of a 64-bit PC) or <span class="command"><strong>make i386_defconfig</strong></span> (in the case of a 32-bit PC).
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TIP</em></span> Dealing with outdated <code class="filename">.config</code> files</strong></p></div></div></div> 
			 <p>
				When you provide a <code class="filename">.config</code> file that has been generated with another (usually older) kernel version, you will have to update it. You can do so with <span class="command"><strong>make oldconfig</strong></span>, it will interactively ask you the questions corresponding to the new configuration options. If you want to use the default answer to all those questions you can use <span class="command"><strong>make olddefconfig</strong></span>. With <span class="command"><strong>make oldnoconfig</strong></span>, it will assume a negative answer to all questions.
			</p>
			 </div>
		</section>
		 <section class="section" id="sect.kernel-build"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.kernel-build"/>8.10.4. Compiling and Building the Package</h3></div></div></div>
			
			 <a id="id-1.11.14.11.2" class="indexterm"></a>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>NOTE</em></span> Clean up before rebuilding</strong></p></div></div></div> 
			 <p>
				If you have already compiled once in the directory and wish to rebuild everything from scratch (for example because you substantially changed the kernel configuration), you will have to run <span class="command"><strong>make clean</strong></span> to remove the compiled files. <span class="command"><strong>make distclean</strong></span> removes even more generated files, including your <code class="filename">.config</code> file too, so make sure to backup it first.
			</p>
			 </div> <p>
				Once the kernel configuration is ready, a simple <span class="command"><strong>make deb-pkg</strong></span> will generate up to 5 Debian packages: <span class="pkg pkg">linux-image-<em class="replaceable">version</em></span> that contains the kernel image and the associated modules, <span class="pkg pkg">linux-headers-<em class="replaceable">version</em></span> which contains the header files required to build external modules, <span class="pkg pkg">linux-firmware-image-<em class="replaceable">version</em></span> which contains the firmware files needed by some drivers (this package might be missing when you build from the kernel sources provided by Debian), <span class="pkg pkg">linux-image-<em class="replaceable">version</em>-dbg</span> which contains the debugging symbols for the kernel image and its modules, and <span class="pkg pkg">linux-libc-dev</span> which contains headers relevant to some user-space libraries like GNU glibc.
			</p>
			 <p>
				The <em class="replaceable">version</em> is defined by the concatenation of the upstream version (as defined by the variables <code class="literal">VERSION</code>, <code class="literal">PATCHLEVEL</code>, <code class="literal">SUBLEVEL</code> and <code class="literal">EXTRAVERSION</code> in the <code class="filename">Makefile</code>), of the <code class="literal">LOCALVERSION</code> configuration parameter, and of the <code class="literal">LOCALVERSION</code> environment variable. The package version reuses the same version string with an appended revision that is regularly incremented (and stored in <code class="filename">.version</code>), except if you override it with the <code class="literal">KDEB_PKGVERSION</code> environment variable.
			</p>
			 
<pre class="screen"><code class="computeroutput">$ </code><strong class="userinput"><code>make deb-pkg LOCALVERSION=-falcot KDEB_PKGVERSION=$(make kernelversion)-1 </code></strong><code class="computeroutput">[...] $ </code><strong class="userinput"><code>ls ../*.deb </code></strong><code class="computeroutput">../linux-headers-3.16.7-ckt4-falcot_3.16.7-1_amd64.deb ../linux-image-3.16.7-ckt4-falcot_3.16.7-1_amd64.deb ../linux-image-3.16.7-ckt4-falcot-dbg_3.16.7-1_amd64.deb ../linux-libc-dev_3.16.7-1_amd64.deb </code></pre>

		</section>
		 <section class="section" id="sect.modules-build"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.modules-build"/>8.10.5. Compiling External Modules</h3></div></div></div>
			
			 <a id="id-1.11.14.12.2" class="indexterm"></a>
			 <a id="id-1.11.14.12.3" class="indexterm"></a>
			 <a id="id-1.11.14.12.4" class="indexterm"></a>
			 <p>
				Some modules are maintained outside of the official Linux kernel. To use them, they must be compiled alongside the matching kernel. A number of common third party modules are provided by Debian in dedicated packages, such as <span class="pkg pkg">xtables-addons-source</span> (extra modules for iptables) or <span class="pkg pkg">oss4-source</span> (Open Sound System, some alternative audio drivers).
			</p>
			 <p>
				These external packages are many and varied and we won't list them all here; the <span class="command"><strong>apt-cache search source$</strong></span> command can narrow down the search field. However, a complete list isn't particularly useful since there is no particular reason for compiling external modules except when you know you need it. In such cases, the device's documentation will typically detail the specific module(s) it needs to function under Linux.
			</p>
			 <p>
				For example, let's look at the <span class="pkg pkg">xtables-addons-source</span> package: after installation, a <code class="filename">.tar.bz2</code> of the module's sources is stored in <code class="filename">/usr/src/</code>. While we could manually extract the tarball and build the module, in practice we prefer to automate all this using DKMS. Most modules offer the required DKMS integration in a package ending with a <code class="literal">-dkms</code> suffix. In our case, installing <span class="pkg pkg">xtables-addons-dkms</span> is all that is needed to compile the kernel module for the current kernel provided that we have the <span class="pkg pkg">linux-headers-*</span> package matching the installed kernel. For instance, if you use <span class="pkg pkg">linux-image-amd64</span>, you would also install <span class="pkg pkg">linux-headers-amd64</span>.
			</p>
			 
<pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>sudo apt install xtables-addons-dkms</code></strong>
<code class="computeroutput"> [...] Setting up xtables-addons-dkms (2.6-1) ... Loading new xtables-addons-2.6 DKMS files... First Installation: checking all kernels... Building only for 3.16.0-4-amd64 Building initial module for 3.16.0-4-amd64 Done. xt_ACCOUNT: Running module version sanity check. - Original module - No original module exists within this kernel - Installation - Installing to /lib/modules/3.16.0-4-amd64/updates/dkms/ [...] DKMS: install completed. $ </code><strong class="userinput"><code>sudo dkms status</code></strong>
<code class="computeroutput">xtables-addons, 2.6, 3.16.0-4-amd64, x86_64: installed $ </code><strong class="userinput"><code>sudo modinfo xt_ACCOUNT</code></strong>
<code class="computeroutput">filename: /lib/modules/3.16.0-4-amd64/updates/dkms/xt_ACCOUNT.ko license: GPL alias: ipt_ACCOUNT author: Intra2net AG &lt;opensource@intra2net.com&gt; description: Xtables: per-IP accounting for large prefixes [...] </code></pre>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>ALTERNATIVE</em></span> module-assistant</strong></p></div></div></div> 
			 <a id="id-1.11.14.12.9.2" class="indexterm"></a>
			 <p>
				Before DKMS, <span class="pkg pkg">module-assistant</span> was the simplest solution to build and deploy kernel modules. It can still be used, in particular for packages lacking DKMS integration: with a simple command like <span class="command"><strong>module-assistant auto-install xtables-addons</strong></span> (or <span class="command"><strong>m-a a-i xtables-addons</strong></span> for short), the modules are compiled for the current kernel, put in a new Debian package, and that package gets installed on the fly.
			</p>
			 </div>
		</section>
		 <section class="section" id="sect.kernel-patch"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="sect.kernel-patch"/>8.10.6. Applying a Kernel Patch</h3></div></div></div>
			
			 <a id="id-1.11.14.13.2" class="indexterm"></a>
			 <a id="id-1.11.14.13.3" class="indexterm"></a>
			 <p>
				Some features are not included in the standard kernel due to a lack of maturity or to some disagreement with the kernel maintainers. Such features may be distributed as patches that anyone is then free to apply to the kernel sources.
			</p>
			 <p>
				Debian distributes some of these patches in <span class="pkg pkg">linux-patch-*</span> or <span class="pkg pkg">kernel-patch-*</span> packages (for instance, <span class="pkg pkg">linux-patch-grsecurity2</span>, which tightens some of the kernel's security policies). These packages install files in the <code class="filename">/usr/src/kernel-patches/</code> directory.
			</p>
			 <p>
				To apply one or more of these installed patches, use the <span class="command"><strong>patch</strong></span> command in the sources directory then start compilation of the kernel as described above.
			</p>
			 
<pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>cd ~/kernel/linux-source-3.16</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>make clean</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>zcat /usr/src/kernel-patches/diffs/grsecurity2/grsecurity-3.0-3.17.1-201410250027.patch.gz | patch -p1</code></strong></pre>
			 <p>
				Note that a given patch may not necessarily work with every version of the kernel; it is possible for <span class="command"><strong>patch</strong></span> to fail when applying them to kernel sources. An error message will be displayed and give some details about the failure; in this case, refer to the documentation available in the Debian package of the patch (in the <code class="filename">/usr/share/doc/linux-patch-*/</code> directory). In most cases, the maintainer indicates for which kernel versions their patch is intended.
			</p>

		</section>

	</section><footer/></body></html>