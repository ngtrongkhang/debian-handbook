<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns:d="http://docbook.org/ns/docbook">11.7. Danh bạ LDAP</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.2" /><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content="Debian-debian-handbook-8-vi-VN-1.0-1" /><meta name="keywords" content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP" /><link rel="home" href="index.html" title="Sổ tay Quản trị Debian" /><link rel="up" href="network-services.html" title="Chương 11. Những dịch vụ mạng: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN" /><link rel="prev" href="sect.http-ftp-proxy.html" title="11.6. Trạm chuyển hướng HTTP/FTP" /><link rel="next" href="sect.rtc-services.html" title="11.8. Real-Time Communication Services" /><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.ldap-directory.html" /></head><body><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><p id="title"><a class="left" href="http://www.debian.org"><img alt="Product Site" src="Common_Content/images//image_left.png" /></a><a class="right" href="index.html"><img alt="Documentation Site" src="Common_Content/images//image_right.png" /></a></p><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.http-ftp-proxy.html"><strong>Trước đó</strong></a></li><li class="home">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.rtc-services.html"><strong>Kế tiếp</strong></a></li></ul><div class="section"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.ldap-directory"></a>11.7. Danh bạ LDAP</h2></div></div></div><a id="id-1.14.10.2" class="indexterm"></a><a id="id-1.14.10.3" class="indexterm"></a><a id="id-1.14.10.4" class="indexterm"></a><div class="para">
			OpenLDAP là một sự hiện thực hoá của giao thức LDAP; nói cách khác, nó là một cơ sở dữ liệu chuyên dùng để lưu trữ danh bạ. Trong trường hợp sử dụng phổ biến nhất, sử dụng một máy phục vụ LDAP cho phép quản lý tập trung các tài khoản người dùng và các quyền sử dụng liên quan. Hơn thế, một cơ sở dữ liệu LDAP rất dễ sao chép, cho phép cài đặt nhiều máy phục vụ LDAP đồng bộ với nhau. Khi mạng và lượng người sử dụng tăng nhanh, tải có thể được cân bằng giữa nhiều máy phục vụ.
		</div><div class="para">
			Dữ liệu LDAP có cấu trúc và có tính hệ thống. Cấu trúc được định nghĩa bởi các “schemas” vốn mô tả các loại đối tượng mà cơ sở dữ liệu lưu trữ, cùng với một danh sách tất cả các đặc trưng có thể có của chúng. Cú pháp được sử dụng để xác định một đối tượng nào đó trong cơ sở dữ liệu được hình thành dựa trên cấu trúc này, vốn cho thấy sự phức tạp của nó.
		</div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.10.7"></a>11.7.1. Cài đặt</h3></div></div></div><div class="para">
				Gói phần mềm <span class="pkg pkg">slapd</span> chứa máy phục vụ OpenLDAP. Gói phần mềm <span class="pkg pkg">ldap-utils</span> bao gồm cả các công cụ dòng lệnh để tương tác với các máy phục vụ LDAP.
			</div><a id="id-1.14.10.7.3" class="indexterm"></a><div class="para">
				Cài đặt <span class="pkg pkg">slapd</span> thường hỏi rất ít câu hỏi và cơ sở dữ liệu có được thường ít đáp ứng được các nhu cầu của bạn. May mắn thay, dòng lệnh đơn giản <code class="command">dpkg-reconfigure slapd</code> sẽ cho phép bạn cấu hình lại cơ sở dữ liệu LDAP với nhiều chi tiết hơn:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						Bỏ qua cấu hình máy phục vụ OpenLDAP? Dĩ nhiên là không, chúng ta muốn cấu hình dịch vụ này.
					</div></li><li class="listitem"><div class="para">
						Tên miền DNS: “<code class="literal">falcot.com</code>”.
					</div></li><li class="listitem"><div class="para">
						Tên tổ chức: “Falcot Corp”.
					</div></li><li class="listitem"><div class="para">
						Các mật mã quản trị cần phải được nhập vào.
					</div></li><li class="listitem"><div class="para">
						Cơ sở dữ liệu để sử dụng ở hậu phương: “MDB”.
					</div></li><li class="listitem"><div class="para">
						Bạn có muốn cơ sở dữ liệu được tháo bỏ khi <span class="pkg pkg">slapd</span> bị xóa? Không. Sẽ không có nghĩa gì khi mạo hiểm mất cơ sở dữ liệu nếu có lỗi phát sinh.
					</div></li><li class="listitem"><div class="para">
						Di chuyển cơ sở dữ liệu cũ? Câu hỏi này chỉ được hỏi khi cấu hình này được thử trong khi cơ sở dữ liệu đã tồn tại. Chỉ trả lời “yes” nếu bạn thực sự muốn bắt đầu lại từ đầu với một cơ sở dữ liệu trống, ví dụ như nếu bạn chạy lệnh <code class="command">dpkg-reconfigure slapd</code> ngay sau lần cài đặt đầu tiên.
					</div></li><li class="listitem"><div class="para">
						Cho phép giao thức LDAP phiên bản số 2? Không, không có lý gì cả. Tất cả các công cụ chúng ta sẽ sử dụng đều đã hiểu được giao thức LDAP phiên bản số 3.
					</div></li></ul></div><div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TRỞ VỀ CƠ BẢN</em></span> Định dạng LDIF</strong></p></div></div></div><div class="para">
				Một tập tin LDIF (<span class="emphasis"><em>Định dạng Trao đổi Dữ liệu LDAP(LDAP Data Interchange Format)</em></span>) là một tập tin chữ cơ động mô tả nội dung của một cơ sở dữ liệu LDAP (hoặc chỉ một phần của nó); điều này có thể được sử dụng để chèn dữ liệu vào bất kỳ một máy phục vụ LDAP nào khác.
			</div><a id="id-1.14.10.7.6.3" class="indexterm"></a></div><div class="para">
				Cơ sở dữ liệu tối thiểu đã được cấu hình, như được trình bày trong truy xuất sau:
			</div><pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>ldapsearch -x -b dc=falcot,dc=com</code></strong>
<code class="computeroutput"># extended LDIF # # LDAPv3 # base &lt;dc=falcot,dc=com&gt; with scope sub # filter: (objectclass=*) # requesting: ALL # # falcot.com dn: dc=falcot,dc=com objectClass: top objectClass: dcObject objectClass: organization o: Falcot Corp dc: falcot # admin, falcot.com dn: cn=admin,dc=falcot,dc=com objectClass: simpleSecurityObject objectClass: organizationalRole cn: admin description: LDAP administrator # search result search: 2 result: 0 Success # numResponses: 3 # numEntries: 2 </code></pre><div class="para">
				Truy xuất trả về hai đối tượng: tổ chức và người dùng quản trị.
			</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.10.8"></a>11.7.2. Điền vào Danh bạ</h3></div></div></div><div class="para">
				Bởi một cơ sở dữ liệu trống không thực sự tiện dụng, chúng ta sẽ chèn tất cả các thư mục hiện có vào nó; điều này bao gồm những người sử dụng, các nhóm, các dịch vụ và các cơ sở dữ liệu về máy tính.
			</div><div class="para">
				Gói phần mềm <span class="pkg pkg">migrationtools</span> cung cấp một tập hợp các kịch bản dành để trích xuất dữ liệu từ các thư mục Unix chuẩn (<code class="filename">/etc/passwd</code>, <code class="filename">/etc/group</code>, <code class="filename">/etc/services</code>, <code class="filename">/etc/hosts</code> và vâng vâng), chuyển đổi dữ liệu này và chèn nó vào cơ sở dữ liệu LDAP.
			</div><a id="id-1.14.10.8.4" class="indexterm"></a><div class="para">
				Một khi gói phần mềm đã được cài đặt, <code class="filename">/etc/migrationtools/migrate_common.ph</code> phải được chỉnh sửa; các lựa chọn <code class="varname">IGNORE_UID_BELOW</code> và <code class="varname">IGNORE_GID_BELOW</code> cần phải được kích hoạt (làm cho chúng không phải ghi chú nữa là đủ), và <code class="varname">DEFAULT_MAIL_DOMAIN</code>/<code class="varname">DEFAULT_BASE</code> cần phải được cập nhật.
			</div><div class="para">
				Hành động di chuyển thực sự được thực hiện bởi lệnh <code class="command">migrate_all_online.sh</code>, như sau:
			</div><pre class="screen">
<code class="computeroutput"># </code><strong class="userinput"><code>cd /usr/share/migrationtools</code></strong>
<code class="computeroutput"># </code><strong class="userinput"><code>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</code></strong></pre><div class="para">
				Lệnh <code class="command">migrate_all_online.sh</code> hỏi một số câu hỏi về cơ sở dữ liệu LDAP mà dữ liệu sẽ được di chuyển vào. <a class="xref" href="sect.ldap-directory.html#tab-migrate-all">Bảng 11.1</a> tóm tắt các câu hỏi được đưa ra trong trường hợp của Falcot.
			</div><div class="table"><a xmlns="" id="tab-migrate-all"></a><p class="title"><strong>Bảng 11.1. Các câu trả lời cho những câu hỏi được hỏi bởi kịch bản <code class="command">migrate_all_online.sh</code></strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary="Các câu trả lời cho những câu hỏi được hỏi bởi kịch bản migrate_all_online.sh"><colgroup><col align="justify" /><col align="justify" /></colgroup><thead><tr><th align="justify">Câu hỏi</th><th align="justify">Câu trả lời</th></tr></thead><tbody><tr><td align="justify">Ngữ cảnh đặt tên X.500</td><td align="justify"><code class="literal">dc=falcot,dc=com</code></td></tr><tr><td align="justify">Tên máy phục vụ LDAP</td><td align="justify"><code class="literal">localhost</code></td></tr><tr><td align="justify">DN của nhà quản lý</td><td align="justify"><code class="literal">cn=admin,dc=falcot,dc=com</code></td></tr><tr><td align="justify">Bind credentials</td><td align="justify">mật mã của quản trị viên</td></tr><tr><td align="justify">Tạo DUAConfigProfile</td><td align="justify">no</td></tr></tbody></table></div></div><div class="para">
				Chúng ta chủ ý phớt lờ việc chuyển dời của tập tin <code class="filename">/etc/aliases</code>, bởi sơ đồ (schema) chuẩn cung cấp bởi Debian không bao gồm các cấu trúc mà kịch bản này sử dụng để mô tả các danh xưng (alias) thư điện tử. Nếu bạn muốn tích hợp dữ liệu này vào một thư mục, tập tin <code class="filename">/etc/ldap/schema/misc.schema</code> nên được thêm vào sơ đồ (schema) chuẩn.
			</div><div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CÔNG CỤ</em></span> Duyệt qua một thư mục LDAP</strong></p></div></div></div><div class="para">
				Lệnh <code class="command">jxplorer</code> (trong gói phần mềm cùng tên) là một công cụ có giao diện đồ hoạ cho phép duyệt và chỉnh sửa một cơ sở dữ liệu LDAP. Đây là một công cụ thú vị cung cấp cho quản trị viên một cái nhìn chung tốt về cấu trúc tầng lớp của dữ liệu LDAP.
			</div><a id="id-1.14.10.8.11.3" class="indexterm"></a></div><div class="para">
				Cũng ghi chú rằng mục đích của lựa chọn <code class="literal">-c</code> cho lệnh <code class="command">ldapadd</code>; lựa chọn này yêu cầu rằng việc xử lý không bị dừng lại khi gặp lỗi. Sử dụng lựa chọn này là bắt buộc bởi việc chuyển đổi <code class="filename">/etc/services</code> thường tạo ra nhiều lỗi vốn có thể được bỏ qua mà không gây ảnh hưởng gì.
			</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.10.9"></a>11.7.3. Quản lý các Tài khoản với LDAP</h3></div></div></div><div class="para">
				Bây giờ cơ sở dữ liệu LDAP chứa một thông tin hữu dụng, đã đến thời điểm để tận dụng dữ liệu này. Phần này tập trung vào làm sao để cấu hình một hệ thống Linux để các thư mục hệ thống có thể tận dung cơ sở dữ liệu LDAP.
			</div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="sect.config-nss"></a>11.7.3.1. Cấu hình NSS</h4></div></div></div><div class="para">
					Hệ thống NSS (Chuyển đổi Dịch vụ Tên, xem ở thanh bên cạnh <a class="xref" href="sect.user-group-databases.html#sidebar.intro-nss"><span class="emphasis"><em>GOING FURTHER</em></span> NSS and system databases</a>) là một hệ thống có cấu trúc mô-đun được thiết kế để định nghĩa hoặc truy xuất thông tin về các thư mục hệ thống. Sử dụng LDAP như một nguồn thông tin cho NSS cần cài đặt gói phần mềm <span class="pkg pkg">libnss-ldap</span>. Quá trình cài đặt của nó hỏi một số câu hỏi; các câu hỏi được tóm tắt trong <a class="xref" href="sect.ldap-directory.html#tab-libnss-ldap">Bảng 11.2</a>.
				</div><a id="id-1.14.10.9.3.3" class="indexterm"></a><div class="table"><a xmlns="" id="tab-libnss-ldap"></a><p class="title"><strong>Bảng 11.2. Cấu hình gói phần mềm <span class="pkg pkg">libnss-ldap</span></strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols gt-7-rows" summary="Cấu hình gói phần mềm libnss-ldap"><colgroup><col align="justify" /><col align="justify" /></colgroup><thead><tr><th align="justify">Câu hỏi</th><th align="justify">Câu trả lời</th></tr></thead><tbody><tr><td align="justify">Định danh thống nhất cho Tài nguyên (Uniform Resource Identifier) máy phục vụ LDAP</td><td align="justify"><code class="literal">ldap://ldap.falcot.com</code></td></tr><tr><td align="justify">Tên đặc biệt của nơi bắt đầu tìm kiếm</td><td align="justify"><code class="literal">dc=falcot,dc=com</code></td></tr><tr><td align="justify">Phiên bản LDAP để sử dụng</td><td align="justify"><code class="literal">3</code></td></tr><tr><td align="justify">Cơ sở dữ liệu LDAP có đòi hỏi đăng nhập?</td><td align="justify">no</td></tr><tr><td align="justify">Các quyền LDAP đặc biệt cho quản trị viên</td><td align="justify">đồng ý</td></tr><tr><td align="justify">Tạo một tập tin cấu hình đọc được/ghi được chỉ bởi người chủ của nó</td><td align="justify">no</td></tr><tr><td align="justify">Tài khoản LDAP cho quản trị viên</td><td align="justify"><code class="literal">cn=admin,dc=falcot,dc=com</code></td></tr><tr><td align="justify">Mật mã tài khoản quản trị viên LDAP</td><td align="justify">mật mã của quản trị viên</td></tr></tbody></table></div></div><div class="para">
					Tập tin <code class="filename">/etc/nsswitch.conf</code> sau đó cần phải được chỉnh sửa, để cấu hình NSS để sử dụng mô-đun mới được cài đặt <code class="command">ldap</code>.
				</div><div class="example"><a xmlns="" id="id-1.14.10.9.3.6"></a><p class="title"><strong>Ví dụ 11.26. Tập tin <code class="filename">/etc/nsswitch.conf</code></strong></p><div class="example-contents"><pre class="programlisting">
# /etc/nsswitch.conf
#
# Ví dụ cấu hình của tính năng Chuyển đổi Dịch vụ Tên của GNU (GNU Name Service Switch).
# Nếu bạn có các gói phần mềm `glibc-doc' và `info' được cài đặt, hãy thử:
# `info libc "Name Service Switch"' để biết thêm về tập tin này.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</pre></div></div><div class="para">
					Mô-đun <code class="command">ldap</code> thường được chèn trước những mô-đun khác, và vì thế nó sẽ được hỏi trước. Ngoại lệ đáng chú ý là dịch vụ <code class="literal">hosts</code> bởi liên lạc với máy phục vụ LDAP cần phải hỏi DNS trước (để giải mã tên <code class="literal">ldap.falcot.com</code>). Không có ngoại lệ, một truy xuất tên máy tính sẽ cố gắng hỏi máy phục vụ LDAP; điều này sẽ kích hoạt giải mã tên miền cho máy phục vụ LDAP, và vâng vâng trong một vòng lặp vô hạn.
				</div><div class="para">
					Nếu máy phục vụ LDAP nên được xem như nguồn thông tin chính xác (và các tập tin nội bộ được sử dụng bởi mô-đun <code class="command">files</code> bị bỏ qua), các dịch vụ có thể được cấu hình với cú pháp sau:
				</div><div class="para">
					<code class="literal"><em class="replaceable">service</em>: ldap [NOTFOUND=return] files</code>.
				</div><div class="para">
					Nếu mục được yêu cầu không tồn tại trong cơ sở dữ liệu LDAP, truy xuất sẽ trả về một câu trả lời “không tồn tại“ thậm chí nếu tài nguyên đó có tồn tại trong một trong các tập tin nội bộ; các tập tin nội bộ này sẽ chỉ được sử dụng nếu dịch vụ LDAP bị sập.
				</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="sect.config-pam"></a>11.7.3.2. Configuring PAM</h4></div></div></div><div class="para">
					This section describes a PAM configuration (see sidebar <a class="xref" href="basic-configuration.html#sidebar.intro-pam"><span class="emphasis"><em>BEHIND THE SCENES</em></span> <code class="filename">/etc/environment</code> and <code class="filename">/etc/default/locale</code></a>) that will allow applications to perform the required authentications against the LDAP database.
				</div><div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CAUTION</em></span> Broken authentication</strong></p></div></div></div><div class="para">
					Changing the standard PAM configuration used by various programs is a sensitive operation. A mistake can lead to broken authentication, which could prevent logging in. Keeping a root shell open is therefore a good precaution. If configuration errors occur, they can be then fixed and the services restarted with minimal effort.
				</div></div><div class="para">
					The LDAP module for PAM is provided by the <span class="pkg pkg">libpam-ldap</span> package. Installing this package asks a few questions very similar to those in <span class="pkg pkg">libnss-ldap</span>; some configuration parameters (such as the URI for the LDAP server) are even actually shared with the <span class="pkg pkg">libnss-ldap</span> package. Answers are summarized in <a class="xref" href="sect.ldap-directory.html#tab-libpam-ldap">Bảng 11.3</a>.
				</div><a id="id-1.14.10.9.4.5" class="indexterm"></a><div class="table"><a xmlns="" id="tab-libpam-ldap"></a><p class="title"><strong>Bảng 11.3. Configuration of <span class="emphasis"><em>libpam-ldap</em></span></strong></p><div class="table-contents"><table xmlns:d="http://docbook.org/ns/docbook" class="lt-4-cols lt-7-rows" summary="Configuration of libpam-ldap"><colgroup><col align="justify" /><col align="justify" /></colgroup><thead><tr><th align="justify">Câu hỏi</th><th align="justify">Câu trả lời</th></tr></thead><tbody><tr><td align="justify">Allow LDAP admin account to behave like local root?</td><td align="justify">Yes. This allows using the usual <code class="command">passwd</code> command for changing passwords stored in the LDAP database.</td></tr><tr><td align="justify">Does the LDAP database require logging in?</td><td align="justify">no</td></tr><tr><td align="justify">Tài khoản LDAP cho quản trị viên</td><td align="justify"><code class="literal">cn=admin,dc=falcot,dc=com</code></td></tr><tr><td align="justify">Mật mã tài khoản quản trị viên LDAP</td><td align="justify">the LDAP database administrative password</td></tr><tr><td align="justify">Local encryption algorithm to use for passwords</td><td align="justify">crypt</td></tr></tbody></table></div></div><div class="para">
					Installing <span class="pkg pkg">libpam-ldap</span> automatically adapts the default PAM configuration defined in the <code class="filename">/etc/pam.d/common-auth</code>, <code class="filename">/etc/pam.d/common-password</code> and <code class="filename">/etc/pam.d/common-account</code> files. This mechanism uses the dedicated <code class="command">pam-auth-update</code> tool (provided by the <span class="pkg pkg">libpam-runtime</span> package). This tool can also be run by the administrator should they wish to enable or disable PAM modules.
				</div><a id="id-1.14.10.9.4.8" class="indexterm"></a><a id="id-1.14.10.9.4.9" class="indexterm"></a><a id="id-1.14.10.9.4.10" class="indexterm"></a><a id="id-1.14.10.9.4.11" class="indexterm"></a><a id="id-1.14.10.9.4.12" class="indexterm"></a><a id="id-1.14.10.9.4.13" class="indexterm"></a></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.10.9.5"></a>11.7.3.3. Securing LDAP Data Exchanges</h4></div></div></div><a id="id-1.14.10.9.5.2" class="indexterm"></a><div class="para">
					By default, the LDAP protocol transits on the network as cleartext; this includes the (encrypted) passwords. Since the encrypted passwords can be extracted from the network, they can be vulnerable to dictionary-type attacks. This can be avoided by using an extra encryption layer; enabling this layer is the topic of this section.
				</div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a xmlns="" id="id-1.14.10.9.5.4"></a>11.7.3.3.1. Configuring the Server</h5></div></div></div><a id="id-1.14.10.9.5.4.2" class="indexterm"></a><a id="id-1.14.10.9.5.4.3" class="indexterm"></a><div class="para">
						The first step is to create a key pair (comprising a public key and a private key) for the LDAP server. The Falcot administrators reuse <span class="emphasis"><em>easy-rsa</em></span> to generate it (see <a class="xref" href="sect.virtual-private-network.html#sect.easy-rsa">Phần 10.2.1.1, “Public Key Infrastructure: <span class="emphasis"><em>easy-rsa</em></span>”</a>). Running <code class="command">./build-key-server ldap.falcot.com</code> asks a few mundane questions (location, organization name and so on). The answer to the “common name” question <span class="emphasis"><em>must</em></span> be the fully-qualified hostname for the LDAP server; in our case, <code class="literal">ldap.falcot.com</code>.
					</div><div class="para">
						This command creates a certificate in the <code class="filename">keys/ldap.falcot.com.crt</code> file; the corresponding private key is stored in <code class="filename">keys/ldap.falcot.com.key</code>.
					</div><div class="para">
						Now these keys have to be installed in their standard location, and we must make sure that the private file is readable by the LDAP server which runs under the <code class="literal">openldap</code> user identity:
					</div><pre class="screen"><code class="computeroutput"># </code><strong class="userinput"><code>adduser openldap ssl-cert </code></strong><code class="computeroutput">Adding user `openldap' to group `ssl-cert' ... Adding user openldap to group ssl-cert Done. # </code><strong class="userinput"><code>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key </code></strong><code class="computeroutput"># </code><strong class="userinput"><code>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key </code></strong><code class="computeroutput"># </code><strong class="userinput"><code>chmod 0640 /etc/ssl/private/ldap.falcot.com.key </code></strong><code class="computeroutput"># </code><strong class="userinput"><code>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem </code></strong></pre><div class="para">
						The <code class="command">slapd</code> daemon also needs to be told to use these keys for encryption. The LDAP server configuration is managed dynamically: the configuration can be updated with normal LDAP operations on the <code class="literal">cn=config</code> object hierarchy, and the server updates <code class="filename">/etc/ldap/slapd.d</code> in real time to make the configuration persistent. <code class="command">ldapmodify</code> is thus the right tool to update the configuration:
					</div><div class="example"><a xmlns="" id="id-1.14.10.9.5.4.9"></a><p class="title"><strong>Ví dụ 11.27. Configuring <code class="command">slapd</code> for encryption</strong></p><div class="example-contents"><pre class="screen"><code class="computeroutput"># </code><strong class="userinput"><code>cat &gt;ssl.ldif &lt;&lt;END dn: cn=config changetype: modify add: olcTLSCertificateFile olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem - add: olcTLSCertificateKeyFile olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key - END </code></strong><code class="computeroutput"># </code><strong class="userinput"><code>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif </code></strong><code class="computeroutput">SASL/EXTERNAL authentication started SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth SASL SSF: 0 modifying entry "cn=config" </code></pre></div></div><div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TOOL</em></span> <code class="command">ldapvi</code> to edit an LDAP directory</strong></p></div></div></div><a id="id-1.14.10.9.5.4.10.2" class="indexterm"></a><div class="para">
						With <code class="command">ldapvi</code>, you can display an LDIF output of any part of the LDAP directory, make some changes in the text editor, and let the tool do the corresponding LDAP operations for you.
					</div><div class="para">
						It is thus a convenient way to update the configuration of the LDAP server, simply by editing the <code class="literal">cn=config</code> hierarchy.
					</div><pre class="screen"><code class="computeroutput"># </code><strong class="userinput"><code>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config </code></strong></pre></div><div class="para">
						The last step for enabling encryption involves changing the <code class="varname">SLAPD_SERVICES</code> variable in the <code class="filename">/etc/default/slapd</code> file. We'll play it safe and disable unsecured LDAP altogether.
					</div><div class="example"><a xmlns="" id="id-1.14.10.9.5.4.12"></a><p class="title"><strong>Ví dụ 11.28. The <code class="filename">/etc/default/slapd</code> file</strong></p><div class="example-contents"><pre class="programlisting">
# Default location of the slapd.conf file or slapd.d cn=config directory. If
# empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
# /etc/ldap/slapd.conf).
SLAPD_CONF=

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="openldap"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="openldap"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf by
# default)
SLAPD_PIDFILE=

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# If SLAPD_NO_START is set, the init script will not start or restart
# slapd (but stop will still work).  Uncomment this if you are
# starting slapd via some other means or if you don't want slapd normally
# started at boot.
#SLAPD_NO_START=1

# If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
# the init script will not start or restart slapd (but stop will still
# work).  Use this for temporarily disabling startup of slapd (when doing
# maintenance, for example, or through a configuration management system)
# when you don't want to edit a configuration file.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# For Kerberos authentication (via SASL), slapd by default uses the system
# keytab file (/etc/krb5.keytab).  To use a different keytab file,
# uncomment this line and change the path.
#export KRB5_KTNAME=/etc/krb5.keytab

# Additional options to pass to slapd
SLAPD_OPTIONS=""
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a xmlns="" id="id-1.14.10.9.5.5"></a>11.7.3.3.2. Configuring the Client</h5></div></div></div><div class="para">
						On the client side, the configuration for the <span class="emphasis"><em>libpam-ldap</em></span> and <span class="emphasis"><em>libnss-ldap</em></span> modules needs to be modified to use an <code class="literal">ldaps://</code> URI.
					</div><div class="para">
						LDAP clients also need to be able to authenticate the server. In a X.509 public key infrastructure, public certificates are signed by the key of a certificate authority (CA). With <span class="emphasis"><em>easy-rsa</em></span>, the Falcot administrators have created their own CA and they now need to configure the system to trust the signatures of Falcot's CA. This can be done by putting the CA certificate in <code class="filename">/usr/local/share/ca-certificates</code> and running <code class="command">update-ca-certificates</code>.
					</div><pre class="screen"><code class="computeroutput"># </code><strong class="userinput"><code>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt </code></strong><code class="computeroutput"># </code><strong class="userinput"><code>update-ca-certificates </code></strong><code class="computeroutput">Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done. Running hooks in /etc/ca-certificates/update.d.... Adding debian:falcot.pem done. done. </code></pre><div class="para">
						Last but not least, the default LDAP URI and default base DN used by the various command line tools can be modified in <code class="filename">/etc/ldap/ldap.conf</code>. This will save quite some typing.
					</div><div class="example"><a xmlns="" id="id-1.14.10.9.5.5.6"></a><p class="title"><strong>Ví dụ 11.29. The <code class="filename">/etc/ldap/ldap.conf</code> file</strong></p><div class="example-contents"><pre class="programlisting">#
# LDAP Defaults
#

# See ldap.conf(5) for details
# This file should be world readable but not world writable.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS certificates (needed for GnuTLS)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt
</pre></div></div></div></div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.http-ftp-proxy.html"><strong>Trước đó</strong>11.6. Trạm chuyển hướng HTTP/FTP</a></li><li class="up"><a accesskey="u" href="#"><strong>Lên</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Đầu</strong></a></li><li class="next"><a accesskey="n" href="sect.rtc-services.html"><strong>Kế tiếp</strong>11.8. Real-Time Communication Services</a></li></ul></body></html>