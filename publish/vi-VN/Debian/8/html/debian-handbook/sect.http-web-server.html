<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>11.2. Máy phục vụ Web (HTTP)</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP"/><link rel="prev" href="network-services.html" title="Chương 11. Những dịch vụ mạng: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN"/><link rel="next" href="sect.ftp-file-server.html" title="11.3. FTP File Server"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/sect.http-web-server.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="network-services.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.ftp-file-server.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section class="section" id="sect.http-web-server"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.http-web-server"/>11.2. Máy phục vụ Web (HTTP)</h2></div></div></div>
		
		 <p>
			Những nhà quản trị của công ty Falcot quyết định sử dụng máy phục vụ HTTP Apache, có sẵn trong Debian <span class="distribution distribution">Jessie</span> tại phiên bản 2.4.10.
		</p>
		 <a id="id-1.14.5.3" class="indexterm"></a>
		 <a id="id-1.14.5.4" class="indexterm"></a>
		 <a id="id-1.14.5.5" class="indexterm"></a>
		 <a id="id-1.14.5.6" class="indexterm"></a>
		 <a id="id-1.14.5.7" class="indexterm"></a>
		 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>LỰA CHỌN THAY THẾ</em></span> Những máy phục vụ web khác</strong></p></div></div></div> 
		 <p>
			Apache chỉ là một máy phục vụ web được biết đến khá nhiều (và được sử dụng rộng rãi), nhưng có những nhà cung cấp khác; họ có thể cung cấp hiệu suất cao dưới một lượng tải nhất định nào đó, nhưng lựa chọn này bị cân bằng lại bởi ít tính năng và mô-đun hơn. Tuy nhiên, khi máy phục vụ web sẽ được lựa chọn để cung cấp các tập tin tĩnh hay để hoạt động như một trạm chuyển hướng, những lựa chọn khác, như là <span class="pkg pkg">nginx</span> và <span class="pkg pkg">lighttpd</span>, rất đáng để xem xét.
		</p>
		 <a id="id-1.14.5.8.3" class="indexterm"></a>
		 <a id="id-1.14.5.8.4" class="indexterm"></a>
		 </div> <section class="section" id="id-1.14.5.9"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.5.9"/>11.2.1. Cài đặt Apache</h3></div></div></div>
			
			 <p>
				Cài đặt gói phần mềm <span class="pkg pkg">apache2</span> là tất cả những gì cần thiết. Nó chứa tất cả các mô-đun, bao gồm <span class="emphasis"><em>Những Mô-đun đa xử lý(Multi-Processing Modules)</em></span> (MPMs) kiểm soát việc Apache thực hiện việc xử lý song song những yêu cầu (những mô-đun trước đây được cung cấp dưới hình thức các gói phần mềm <span class="pkg pkg">apache2-mpm-*</span> rời rạc). Nó sẽ kéo về gói phần mềm <span class="pkg pkg">apache2-utils</span> vốn chứa những tiện ích dòng lệnh mà chúng ta sẽ khám phá sau.
			</p>
			 <p>
				MPM khi đang hoạt động ảnh hưởng lớn đến cách Apache xử lý các yêu cầu cùng lúc. Với MPM <span class="emphasis"><em>worker</em></span>, nó sử dụng các <span class="emphasis"><em>thread</em></span> (các tiến trình nhỏ và nhẹ), trong khi MPM <span class="emphasis"><em>prefork</em></span> sử dụng một kho tiến trình được tạo sẵn từ trước. Với MPM <span class="emphasis"><em>event</em></span>, nó cũng sử dụng các thread, nhưng các kết nối không có tín hiệu gì (đặc biệt những cái được giữ chạy bởi tính năng HTTP <span class="emphasis"><em>keep-alive</em></span>) được gửi lại cho một thread riêng quản lý.
			</p>
			 <p>
				Các nhà quản trị hệ thống Falcot cũng cài <span class="pkg pkg">libapache2-mod-php5</span> để đưa hỗ trợ PHP vào trong Apache. Điều này làm cho MPM <span class="emphasis"><em>event</em></span> ngầm định bị tắt đi, và <span class="emphasis"><em>prefork</em></span> được đưa vào sử dụng thay thế, bởi PHP chỉ hoạt động với MPM đó mà thôi.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>AN NINH</em></span> Thực thi dưới người dùng <code class="literal">www-data</code> </strong></p></div></div></div> 
			 <a id="id-1.14.5.9.5.2" class="indexterm"></a>
			 <a id="id-1.14.5.9.5.3" class="indexterm"></a>
			 <p>
				Theo ngầm định, Apache xử lý các yêu cầu đến dưới quyền người dùng của tài khoản <code class="literal">www-data</code>. Điều này nghĩa là một lỗ hổng bảo mật trong một đoạn mã kịch bản CGI thực thi bởi Apache (cho một trang web động) sẽ không làm lộ cả một hệ thống, nhưng chỉ nhưng tập tin được sở hữu bởi người sử dụng này.
			</p>
			 <p>
				Sử dụng các mô-đun <span class="emphasis"><em>suexec</em></span> cho phép vượt qua quy tắc này để một số đoạn mã CGI được thực thi dưới quyền người dùng của một tài khoản khác. Điều này được cấu hình bởi chỉ thị <code class="literal">SuexecUserGroup <em class="replaceable">user</em><em class="replaceable">group</em></code> trong cấu hình Apache.
			</p>
			 <a id="id-1.14.5.9.5.6" class="indexterm"></a>
			 <p>
				Một khả năng khác là sử dụng một MPM chuyên dụng, như là cái được cung cấp bởi <span class="pkg pkg">libapache2-mpm-itk</span>. Cái này có một hành vi hoàn toàn khác: nó cho phép “cách ly“ các máy ảo(virtual hosts) (thực ra, những tập hợp các trang) để mỗi cái trong số đó chạy dưới một người sử dụng khác nhau. Một lỗ hổng khác trong một trang web vì thế sẽ không thể làm lộ các tập tin thuộc về người sở hữu của trang web khác.
			</p>
			 </div> <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>SƠ LƯỢC</em></span> Danh sách các mô-đun</strong></p></div></div></div> 
			 <p>
				Danh sách đầy đủ của các mô-đun chuẩn của Apache có thể tìm thấy trên mạng. <a class="ulink" href="http://httpd.apache.org/docs/2.4/mod/index.html">http://httpd.apache.org/docs/2.4/mod/index.html</a>
			</p>
			 </div> <p>
				Apache là một máy phục vụ cấu thành bởi nhiều mô-đun, và nhiều tính năng của nó được tạo ra bởi những mô-đun bên ngoài mà chương trình chính sẽ thực thi trong quá trình khởi động. Cấu hình ngầm định chỉ kích hoạt các mô-đun phổ biến nhất, nhưng để kích hoạt các mô-đun mới này chỉ cần đơn giản chạy lệnh <span class="command"><strong>a2enmod <em class="replaceable">module</em></strong></span>; để tắt một mô-đun, lệnh là <span class="command"><strong>a2dismod <em class="replaceable">module</em></strong></span>. Những chương trình này thực ra chỉ tạo (hoặc xóa) các đường link tượng trưng(symbolic links) trong <code class="filename">/etc/apache2/mods-enabled/</code>, vốn chỉ đến những tập tin thực sự (lưu trong <code class="filename">/etc/apache2/mods-available/</code>).
			</p>
			 <p>
				Với cấu hình ngầm định của nó, máy phục vụ web lắng nghe trên cổng 80 (như được cấu hình trong tập tin <code class="filename">/etc/apache2/ports.conf</code>), và phục vụ các trang nằm trong thư mục <code class="filename">/var/www/html/</code> (như được cấu hình trong tập tin <code class="filename">/etc/apache2/sites-enabled/000-default.conf</code>).
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TÌM HIỂU THÊM</em></span> Thêm hỗ trợ cho SSL</strong></p></div></div></div> 
			 <a id="id-1.14.5.9.9.2" class="indexterm"></a>
			 <a id="id-1.14.5.9.9.3" class="indexterm"></a>
			 <p>
				Apache 2.4 có sẵn một mô-đun SSL buộc phải có để hỗ trợ HTTP an toàn (HTTPS). Nó chỉ cần được kích hoạt với lệnh <span class="command"><strong>a2enmod ssl</strong></span>, sau đó các chỉ thị buộc phải có phải được thêm vào các tập tin cấu hình. Một ví dụ cấu hình được cung cấp trong <code class="filename">/etc/apache2/sites-available/default-ssl.conf</code>. <a class="ulink" href="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html">http://httpd.apache.org/docs/2.4/mod/mod_ssl.html</a>
			</p>
			 <p>
				Phải cẩn thận hơn nếu bạn muốn ưu tiên các kết nối SSL với <span class="emphasis"><em>Bí mật Chiều đi Hoàn hảo(Perfect Forward Secrecy)</em></span> (những kết nối sử dụng các mã phiên làm việc tạm thời để đảm bảo rằng việc lộ mã bí mật của máy phục vụ không dẫn đến việc lộ thông tin cũ đã được mã hóa vốn có thể bị lưu lại trước đây khi có ai nghe lén trên đường truyền). Quan sát các đề xuất của Mozilla, cụ thể là ở <a class="ulink" href="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache">https://wiki.mozilla.org/Security/Server_Side_TLS#Apache</a>
			</p>
			 <a id="id-1.14.5.9.9.6" class="indexterm"></a>
			 </div>
		</section>
		 <section class="section" id="id-1.14.5.10"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.5.10"/>11.2.2. Cấu hình các máy ảo</h3></div></div></div>
			
			 <p>
				Một máy ảo là một danh xưng thêm cho một máy phục vụ.
			</p>
			 <a id="id-1.14.5.10.3" class="indexterm"></a>
			 <p>
				Apache có hai loại máy ảo khác nhau: một loại dựa trên địa chỉ IP (hoặc cổng), và một loại dựa trên tên miền của máy phục vụ web. Phương thức đầu tiên cần tạo một địa chỉ IP khác nhau (hay cổng) cho mỗi trang, trong khi phương thức số hai có thể hoạt động với một địa chỉ IP (và cổng) duy nhất, và những trang phân biệt bởi tên máy gửi bởi chương trình khách HTTP (vốn chỉ hoạt động tốt với phiên bản 1.1 của nghi thức HTTP - may mắn rằng phiên bản này đủ lâu để tất cả các chương trình khách đã sử dụng nó lâu rồi).
			</p>
			 <p>
				Sự khan hiếm ngày càng tăng của các địa chỉ IPv4 dẫn đến sự ưu tiên của phương thức số hai; tuy nhiên, nó được làm cho phức tạp hơn nếu các máy ảo cần cung cung cấp HTTPS, bởi vì giao thức SSL không luôn luôn cung cấp lưu trữ ảo dựa trên tên; phần mở rộng SNI (<span class="emphasis"><em>Tín hiệu chọn tên (Server Name Indication)</em></span>) vốn cho phép một sự kết hợp như vậy không được xử lý bởi tất cả trình duyệt. Khi vào trang HTTPS cần chạy trên cùng một máy phục vụ, chúng sẽ được phân biệt bằng việc chạy trên một cổng riêng biệt hoặc chạy trên một địa chỉ IP riêng biệt (IPv6 có thể giúp ích ở đây).
			</p>
			 <p>
				Cấu hình ngầm định của Apache 2 cho phép các máy ảo dựa trên tên. Hơn nữa, một máy phục vụ ngầm định được định nghĩa trong tập tin <code class="literal">/etc/apache2/sites-enabled/000-default.conf</code>; máy ảo này sẽ được sử dụng nếu không máy được tìm thấy nào hợp với yêu cầu gửi bởi khách.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CẢNH BÁO</em></span> Máy ảo đầu tiên</strong></p></div></div></div> 
			 <p>
				Những yêu cầu liên quan tới những máy ảo sẽ luôn được phục vụ bởi máy ảo ngầm định đầu tiên. Đó là lý do chúng ta định nghĩa <code class="literal">www.falcot.com</code> đầu tiên ở đây.
			</p>
			 </div> <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>SƠ LƯỢC</em></span> Apache hỗ trợ SNI</strong></p></div></div></div> 
			 <a id="id-1.14.5.10.8.2" class="indexterm"></a>
			 <p>
				Máy phục vụ Apache hỗ trợ một phần mở rộng của nghi thức SSL được gọi là <span class="emphasis"><em>Tín hiệu chọn tên(Server Name Indication)</em></span> (SNI). Phần mở rộng cho phép trình duyệt gửi tên máy của một máy phục vụ trong quá trình thiết lập kết nối SSL, sớm hơn nhiều so với chính yêu cầu HTTP, vốn được sử dụng trước đó để nhận dạng máy ảo được yêu cầu trong những máy được lưu trữ trên cùng một máy phục vụ (với cùng một địa chỉ IP và cổng). Điều này cho phép Apache chọn chứng chỉ SSL phù hợp nhất để tiếp tục giao dịch.
			</p>
			 <p>
				Trước SNI, Apache sẽ luôn sử dụng chứng chỉ được định nghĩa trong máy ảo ngầm định. Các máy khách cố gắng truy cập một máy ảo khác sẽ hiển thị các cảnh báo, bởi chứng chỉ chúng nhận được không hợp với trang web họ đang cố gắng truy cập. May mắn thay, đa số trình duyệt bây giờ làm việc với SNI; chúng bao gồm Microsoft Internet Explorer bắt đầu với phiên bản 7.0 (trên Vista), Mozilla Firefox bắt đầu với phiên bản 2.0, Apple Safari từ phiên bản 3.2.1, và tất cả các phiên bản của Google Chrome.
			</p>
			 <p>
				Gói phần mềm Apache cung cấp bởi Debian được xây dựng với hỗ trợ cho SNI; vì thế không cấu hình cụ thể nào là cần thiết.
			</p>
			 <p>
				Phải cẩn thận hơn trong việc đảm bảo rằng cấu hình cho máy ảo đầu tiên (cái được sử dụng ngầm định) kích hoạt TLSv1, bởi Apache dùng các tham số của máy ảo ngầm định đầu tiên để thiết lập các kết nối an toàn, và các kết nối này tốt hơn là nên cho phép chúng.
			</p>
			 </div> <p>
				Mỗi máy ảo thêm được mô tả bởi một tập tin được lưu trong <code class="filename">/etc/apache2/sites-available/</code>. Vì thế, cài đặt một trang web cho miền <code class="literal">falcot.org</code> đơn giản chỉ là tạo một tập tin sau, sau đó kích hoạt máy ảo với lệnh <span class="command"><strong>a2ensite www.falcot.org</strong></span>.
			</p>
			 <div class="example" id="id-1.14.5.10.10"><a xmlns="" id="id-1.14.5.10.10"/><p class="title"><strong>Ví dụ 11.16. Tập tin <code class="filename">/etc/apache2/sites-available/www.falcot.org.conf</code></strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</pre>

			</div></div>
			 <p>
				Máy phục vụ Apache, như được cấu hình như trước đây, sử dụng chung những tập tin nhật ký cho tất cả các máy ảo (mặc dù điều này có thể được thay đổi bằng việc thêm các chỉ thị <code class="literal">CustomLog</code> vào các định nghĩa của các máy ảo). Vì thế sẽ có lý khi tùy chỉnh định dạng của tập tin nhật ký này để nhờ nó đính kèm tên của máy ảo. Điều này có thể được thực hiện bằng việc tạo một <code class="filename">/etc/apache2/conf-available/customlog.conf</code> vốn định nghĩa một định dạng mới cho tất cả các tập tin nhật ký (với chỉ thị <code class="literal">LogFormat</code>) và bằng việc kích hoạt nó với lệnh <span class="command"><strong>a2enconf customlog</strong></span>. Dòng <code class="literal">CustomLog</code> phải được xóa bỏ (hay chuyển thành ghi chú) khỏi tập tin <code class="filename">/etc/apache2/sites-available/000-default.conf</code>.
			</p>
			 <div class="example" id="id-1.14.5.10.12"><a xmlns="" id="id-1.14.5.10.12"/><p class="title"><strong>Ví dụ 11.17. Tập tin <code class="filename">/etc/apache2/conf.d/customlog.conf</code></strong></p><div class="example-contents">
				
				 
<pre class="programlisting scale scale">
# Định dạng nhật ký mới bao gồm tên máy (ảo)
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Bây giờ hãy sử dụng định dạng "vhost" cho lựa chọn ngầm định
CustomLog /var/log/apache2/access.log vhost</pre>

			</div></div>

		</section>
		 <section class="section" id="id-1.14.5.11"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.5.11"/>11.2.3. Common Directives</h3></div></div></div>
			
			 <p>
				This section briefly reviews some of the commonly-used Apache configuration directives.
			</p>
			 <a id="id-1.14.5.11.3" class="indexterm"></a>
			 <a id="id-1.14.5.11.4" class="indexterm"></a>
			 <p>
				The main configuration file usually includes several <code class="literal">Directory</code> blocks; they allow specifying different behaviors for the server depending on the location of the file being served. Such a block commonly includes <code class="literal">Options</code> and <code class="literal">AllowOverride</code> directives.
			</p>
			 <a id="id-1.14.5.11.6" class="indexterm"></a>
			 <a id="id-1.14.5.11.7" class="indexterm"></a>
			 <div class="example" id="id-1.14.5.11.8"><a xmlns="" id="id-1.14.5.11.8"/><p class="title"><strong>Ví dụ 11.18. Directory block</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;
</pre>

			</div></div>
			 <p>
				The <code class="literal">DirectoryIndex</code> directive contains a list of files to try when the client request matches a directory. The first existing file in the list is used and sent as a response.
			</p>
			 <a id="id-1.14.5.11.10" class="indexterm"></a>
			 <p>
				The <code class="literal">Options</code> directive is followed by a list of options to enable. The <code class="literal">None</code> value disables all options; correspondingly, <code class="literal">All</code> enables them all except <code class="literal">MultiViews</code>. Available options include:
			</p>
			 <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<p>
						<code class="literal">ExecCGI</code> indicates that CGI scripts can be executed. <a id="id-1.14.5.11.12.1.1.2" class="indexterm"></a>
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">FollowSymlinks</code> tells the server that symbolic links can be followed, and that the response should contain the contents of the target of such links. <a id="id-1.14.5.11.12.2.1.2" class="indexterm"></a>
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">SymlinksIfOwnerMatch</code> also tells the server to follow symbolic links, but only when the link and the its target have the same owner. <a id="id-1.14.5.11.12.3.1.2" class="indexterm"></a>
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">Includes</code> enables <span class="emphasis"><em>Server Side Includes</em></span> (<span class="emphasis"><em>SSI</em></span> for short). These are directives embedded in HTML pages and executed on the fly for each request. <a id="id-1.14.5.11.12.4.1.4" class="indexterm"></a>
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">Indexes</code> tells the server to list the contents of a directory if the HTTP request sent by the client points at a directory without an index file (ie, when no files mentioned by the <code class="literal">DirectoryIndex</code> directive exists in this directory). <a id="id-1.14.5.11.12.5.1.3" class="indexterm"></a>
					</p>

				</li><li class="listitem">
					<p>
						<code class="literal">MultiViews</code> enables content negotiation; this can be used by the server to return a web page matching the preferred language as configured in the browser. <a id="id-1.14.5.11.12.6.1.2" class="indexterm"></a>
					</p>

				</li></ul></div>
			 <p>
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>BACK TO BASICS</em></span> <code class="filename">.htaccess</code> file</strong></p></div></div></div> 
			 <p>
				The <code class="filename">.htaccess</code> file contains Apache configuration directives enforced each time a request concerns an element of the directory where it is stored. The scope of these directives also recurses to all the subdirectories within.
			</p>
			 <a id="id-1.14.5.11.14.3" class="indexterm"></a>
			 <p>
				Most of the directives that can occur in a <code class="literal">Directory</code> block are also legal in a <code class="filename">.htaccess</code> file.
			</p>
			 </div> <p>
				The <code class="literal">AllowOverride</code> directive lists all the options that can be enabled or disabled by way of a <code class="filename">.htaccess</code> file. A common use of this option is to restrict <code class="literal">ExecCGI</code>, so that the administrator chooses which users are allowed to run programs under the web server's identity (the <code class="literal">www-data</code> user).
			</p>
			 <a id="id-1.14.5.11.16" class="indexterm"></a>
			 <section class="section" id="id-1.14.5.11.17"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.5.11.17"/>11.2.3.1. Requiring Authentication</h4></div></div></div>
				
				 <a id="id-1.14.5.11.17.2" class="indexterm"></a>
				 <p>
					In some circumstances, access to part of a website needs to be restricted, so only legitimate users who provide a username and a password are granted access to the contents.
				</p>
				 <div class="example" id="id-1.14.5.11.17.4"><a xmlns="" id="id-1.14.5.11.17.4"/><p class="title"><strong>Ví dụ 11.19. <code class="filename">.htaccess</code> file requiring authentication</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private
</pre>

				</div></div>
				 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>SECURITY</em></span> No security</strong></p></div></div></div> 
				 <p>
					The authentication system used in the above example (<code class="literal">Basic</code>) has minimal security as the password is sent in clear text (it is only encoded as <span class="emphasis"><em>base64</em></span>, which is a simple encoding rather than an encryption method). It should also be noted that the documents “protected” by this mechanism also go over the network in the clear. If security is important, the whole HTTP connection should be encrypted with SSL.
				</p>
				 </div> <p>
					The <code class="filename">/etc/apache2/authfiles/htpasswd-private</code> file contains a list of users and passwords; it is commonly manipulated with the <span class="command"><strong>htpasswd</strong></span> command. For example, the following command is used to add a user or change their password: <a id="id-1.14.5.11.17.6.3" class="indexterm"></a>
				</p>
				 
<pre class="screen">
<code class="computeroutput"># </code><strong class="userinput"><code>htpasswd /etc/apache2/authfiles/htpasswd-private <em class="replaceable">user</em></code></strong><code class="computeroutput">New password: Re-type new password: Adding password for user <em class="replaceable">user</em></code></pre>

			</section>
			 <section class="section" id="id-1.14.5.11.18"><div class="titlepage"><div><div><h4 class="title"><a xmlns="" id="id-1.14.5.11.18"/>11.2.3.2. Restricting Access</h4></div></div></div>
				
				 <a id="id-1.14.5.11.18.2" class="indexterm"></a>
				 <p>
					The <code class="literal">Require</code> directive controls access restrictions for a directory (and its subdirectories, recursively).
				</p>
				 <a id="id-1.14.5.11.18.4" class="indexterm"></a>
				 <a id="id-1.14.5.11.18.5" class="indexterm"></a>
				 <a id="id-1.14.5.11.18.6" class="indexterm"></a>
				 <p>
					It can be used to restrict access based on many criteria; we will stop at describing access restriction based on the IP address of the client, but it can be made much more powerful than that, especially when several <code class="literal">Require</code> directives are combined within a <code class="literal">RequireAll</code> block.
				</p>
				 <div class="example" id="id-1.14.5.11.18.8"><a xmlns="" id="id-1.14.5.11.18.8"/><p class="title"><strong>Ví dụ 11.20. Only allow from the local network</strong></p><div class="example-contents">
					
					 
<pre class="programlisting">Require ip 192.168.0.0/16
</pre>

				</div></div>
				 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>ALTERNATIVE</em></span> Old syntax</strong></p></div></div></div> 
				 <p>
					The <code class="literal">Require</code> syntax is only available in Apache 2.4 (the version in <span class="distribution distribution">Jessie</span>). For users of <span class="distribution distribution">Wheezy</span>, the Apache 2.2 syntax is different, and we describe it here mainly for reference, although it can also be made available in Apache 2.4 using the <code class="literal">mod_access_compat</code> module.
				</p>
				 <p>
					The <code class="literal">Allow from</code> and <code class="literal">Deny from</code> directives control access restrictions for a directory (and its subdirectories, recursively).
				</p>
				 <a id="id-1.14.5.11.18.9.4" class="indexterm"></a>
				 <a id="id-1.14.5.11.18.9.5" class="indexterm"></a>
				 <a id="id-1.14.5.11.18.9.6" class="indexterm"></a>
				 <p>
					The <code class="literal">Order</code> directive tells the server of the order in which the <code class="literal">Allow from</code> and <code class="literal">Deny from</code> directives are applied; the last one that matches takes precedence. In concrete terms, <code class="literal">Order deny,allow</code> allows access if no <code class="literal">Deny from</code> applies, or if an <code class="literal">Allow from</code> directive does. Conversely, <code class="literal">Order allow,deny</code> rejects access if no <code class="literal">Allow from</code> directive matches (or if a <code class="literal">Deny from</code> directive applies).
				</p>
				 <p>
					The <code class="literal">Allow from</code> and <code class="literal">Deny from</code> directives can be followed by an IP address, a network (such as <code class="literal">192.168.0.0/255.255.255.0</code>, <code class="literal">192.168.0.0/24</code> or even <code class="literal">192.168.0</code>), a hostname or a domain name, or the <code class="literal">all</code> keyword, designating everyone.
				</p>
				 <p>
					For instance, to reject connections by default but allow them from the local network, you could use this:
				</p>
				 
<pre class="programlisting">
Order deny,allow
Allow from 192.168.0.0/16
Deny from all
</pre>
				 </div>
			</section>

		</section>
		 <section class="section" id="id-1.14.5.12"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.14.5.12"/>11.2.4. Log Analyzers</h3></div></div></div>
			
			 <p>
				A log analyzer is frequently installed on a web server; since the former provides the administrators with a precise idea of the usage patterns of the latter.
			</p>
			 <p>
				The Falcot Corp administrators selected <span class="emphasis"><em>AWStats</em></span> (<span class="emphasis"><em>Advanced Web Statistics</em></span>) to analyze their Apache log files.
			</p>
			 <a id="id-1.14.5.12.4" class="indexterm"></a>
			 <a id="id-1.14.5.12.5" class="indexterm"></a>
			 <a id="id-1.14.5.12.6" class="indexterm"></a>
			 <a id="id-1.14.5.12.7" class="indexterm"></a>
			 <p>
				The first configuration step is the customization of the <code class="filename">/etc/awstats/awstats.conf</code> file. The Falcot administrators keep it unchanged apart from the following parameters:
			</p>
			 
<pre class="programlisting">
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"
</pre>
			 <p>
				All these parameters are documented by comments in the template file. In particular, the <code class="varname">LogFile</code> and <code class="varname">LogFormat</code> parameters describe the location and format of the log file and the information it contains; <code class="varname">SiteDomain</code> and <code class="varname">HostAliases</code> list the various names under which the main web site is known.
			</p>
			 <p>
				For high traffic sites, <code class="varname">DNSLookup</code> should usually not be set to <code class="literal">1</code>; for smaller sites, such as the Falcot one described above, this setting allows getting more readable reports that include full machine names instead of raw IP addresses.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>SECURITY</em></span> Access to statistics</strong></p></div></div></div> 
			 <p>
				AWStats makes its statistics available on the website with no restrictions by default, but restrictions can be set up so that only a few (probably internal) IP addresses can access them; the list of allowed IP addresses needs to be defined in the <code class="varname">AllowAccessFromWebToFollowingIPAddresses</code> parameter
			</p>
			 </div> <p>
				AWStats will also be enabled for other virtual hosts; each virtual host needs its own configuration file, such as <code class="filename">/etc/awstats/awstats.www.falcot.org.conf</code>.
			</p>
			 <div class="example" id="id-1.14.5.12.14"><a xmlns="" id="id-1.14.5.12.14"/><p class="title"><strong>Ví dụ 11.21. AWStats configuration file for a virtual host</strong></p><div class="example-contents">
				
				 
<pre class="programlisting">
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"
</pre>

			</div></div>
			 <p>
				AWStats uses many icons stored in the <code class="filename">/usr/share/awstats/icon/</code> directory. In order for these icons to be available on the web site, the Apache configuration needs to be adapted to include the following directive:
			</p>
			 
<pre class="programlisting">
Alias /awstats-icon/ /usr/share/awstats/icon/
</pre>
			 <p>
				After a few minutes (and once the script has been run a few times), the results are available online: <a class="ulink" href="http://www.falcot.com/cgi-bin/awstats.pl">http://www.falcot.com/cgi-bin/awstats.pl</a><a class="ulink" href="http://www.falcot.org/cgi-bin/awstats.pl">http://www.falcot.org/cgi-bin/awstats.pl</a>
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>CAUTION</em></span> Log file rotation</strong></p></div></div></div> 
			 <p>
				In order for the statistics to take all the logs into account, <span class="emphasis"><em>AWStats</em></span> needs to be run right before the Apache log files are rotated. Looking at the <code class="literal">prerotate</code> directive of <code class="filename">/etc/logrotate.d/apache2</code> file, this can be solved by putting a symlink to <code class="filename">/usr/share/awstats/tools/update.sh</code> in <code class="filename">/etc/logrotate.d/httpd-prerotate</code>:
			</p>
			 
<pre class="screen"><code class="computeroutput">$ </code><strong class="userinput"><code>cat /etc/logrotate.d/apache2 </code></strong><code class="computeroutput">/var/log/apache2/*.log { daily missingok rotate 14 compress delaycompress notifempty create 644 root adm sharedscripts postrotate if /etc/init.d/apache2 status &gt; /dev/null ; then \ /etc/init.d/apache2 reload &gt; /dev/null; \ fi; endscript prerotate if [ -d /etc/logrotate.d/httpd-prerotate ]; then \ run-parts /etc/logrotate.d/httpd-prerotate; \ fi; \ endscript } $ </code><strong class="userinput"><code>sudo mkdir -p /etc/logrotate.d/httpd-prerotate </code></strong><code class="computeroutput">$ </code><strong class="userinput"><code>sudo ln -sf /usr/share/awstats/tools/update.sh \ /etc/logrotate.d/httpd-prerotate/awstats </code></strong></pre>
			 <p>
				Note also that the log files created by <span class="command"><strong>logrotate</strong></span> need to be readable by everyone, especially AWStats. In the above example, this is ensured by the <code class="literal">create 644 root adm</code> line (instead of the default <code class="literal">640</code> permissions).
			</p>
			 </div>
		</section>

	</section><footer/></body></html>