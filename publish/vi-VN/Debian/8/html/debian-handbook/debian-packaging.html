<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chương 15. Creating a Debian Package</title><meta name="generator" content="publican v4.3.2"/><meta name="keywords" content="Backport, Rebuild, Source package, Archive, Meta-package, Debian Developer, Maintainer"/><link rel="prev" href="sect.dealing-with-compromised-machine.html" title="14.7. Dealing with a Compromised Machine"/><link rel="next" href="sect.building-first-package.html" title="15.2. Building your First Package"/><link xmlns="" rel="canonical" href="https://debian-handbook.info/browse/vi-VN/stable/debian-packaging.html"/></head><body onLoad="initSwitchery(); jQuery(&quot;#poptoc&quot;).load('index.html .toc:eq(0)'); jQuery('.programlisting').each(function(i, block){hljs.highlightBlock(block);});" onClick="hide('poptoc');"><header><div id="banner"><a href="http://debian-handbook.info/get/"><span class="text">Download the ebook</span></a></div><ul class="docnav top"><li class="previous"><a accesskey="p" href="sect.dealing-with-compromised-machine.html"><strong>Trước đó</strong></a></li><li class="home" onClick="work=1;showhide('poptoc');">Sổ tay Quản trị Debian</li><li class="next"><a accesskey="n" href="sect.building-first-package.html"><strong>Kế tiếp</strong></a></li></ul></header><div id="poptoc" class="hidden"> </div><section xml:lang="vi-VN" class="chapter" id="debian-packaging"><div class="titlepage"><div><div><h1 class="title"><a xmlns="" id="debian-packaging"/>Chương 15. Creating a Debian Package</h1></div></div></div>
	
	 
	 <div class="highlights"> <p>
		It is quite common, for an administrator who has been handling Debian packages in a regular fashion, to eventually feel the need to create their own packages, or to modify an existing package. This chapter aims to answer the most common questions in this field, and provide the required elements to take advantage of the Debian infrastructure in the best way. With any luck, after trying your hand for local packages, you may even feel the need to go further than that and join the Debian project itself!
	</p>
	 </div> <section class="section" id="sect.rebuilding-package"><div class="titlepage"><div><div><h2 class="title"><a xmlns="" id="sect.rebuilding-package"/>15.1. Rebuilding a Package from its Sources</h2></div></div></div>
		
		 <p>
			Rebuilding a binary package is required under several sets of circumstances. In some cases, the administrator needs a software feature that requires the software to be compiled from sources, with a particular compilation option; in others, the software as packaged in the installed version of Debian is not recent enough. In the latter case, the administrator will usually build a more recent package taken from a newer version of Debian — such as <span class="distribution distribution">Testing</span> or even <span class="distribution distribution">Unstable</span> — so that this new package works in their <span class="distribution distribution">Stable</span> distribution; this operation is called “backporting”. As usual, care should be taken, before undertaking such a task, to check whether it has been done already — a quick look on the Debian Package Tracker for that package will reveal that information. <a class="ulink" href="https://tracker.debian.org/">https://tracker.debian.org/</a> <a id="id-1.18.4.2.5" class="indexterm"></a>
		</p>
		 <section class="section" id="id-1.18.4.3"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.18.4.3"/>15.1.1. Getting the Sources</h3></div></div></div>
			
			 <p>
				Rebuilding a Debian package starts with getting its source code. The easiest way is to use the <span class="command"><strong>apt-get source <em class="replaceable">source-package-name</em></strong></span> command. This command requires a <code class="literal">deb-src</code> line in the <code class="filename">/etc/apt/sources.list</code> file, and up-to-date index files (i.e. <span class="command"><strong>apt-get update</strong></span>). These conditions should already be met if you followed the instructions from the chapter dealing with APT configuration (see <a class="xref" href="apt.html#sect.apt-sources.list" title="6.1. Thêm nội dung vào tệp sources.list">Phần 6.1, “Thêm nội dung vào tệp <code class="filename">sources.list</code>”</a>). Note however, that you will be downloading the source packages from the Debian version mentioned in the <code class="literal">deb-src</code> line. If you need another version, you may need to download it manually from a Debian mirror or from the web site. This involves fetching two or three files (with extensions <code class="filename">*.dsc</code> — for <span class="emphasis"><em>Debian Source Control</em></span> — <code class="filename">*.tar.<em class="replaceable">comp</em></code>, and sometimes <code class="filename">*.diff.gz</code> or <code class="filename">*.debian.tar.<em class="replaceable">comp</em></code> — <em class="replaceable">comp</em> taking one value among <code class="literal">gz</code>, <code class="literal">bz2</code> or <code class="literal">xz</code> depending on the compression tool in use), then run the <span class="command"><strong>dpkg-source -x <em class="replaceable">file.dsc</em></strong></span> command. If the <code class="filename">*.dsc</code> file is directly accessible at a given URL, there is an even simpler way to fetch it all, with the <span class="command"><strong>dget <em class="replaceable">URL</em></strong></span> command. This command (which can be found in the <span class="pkg pkg">devscripts</span> package) fetches the <code class="filename">*.dsc</code> file at the given address, then analyzes its contents, and automatically fetches the file or files referenced within. Once everything has been downloaded, it extracts the source package (unless the <code class="literal">-d</code> or <code class="literal">--download-only</code> option is used).
			</p>

		</section>
		 <section class="section" id="id-1.18.4.4"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.18.4.4"/>15.1.2. Making Changes</h3></div></div></div>
			
			 <p>
				The source of the package is now available in a directory named after the source package and its version (for instance, <span class="emphasis"><em>samba-4.1.17+dfsg</em></span>); this is where we'll work on our local changes.
			</p>
			 <p>
				The first thing to do is to change the package version number, so that the rebuilt packages can be distinguished from the original packages provided by Debian. Assuming the current version is <code class="literal">2:4.1.17+dfsg-2</code>, we can create version <code class="literal">2:4.1.17+dfsg-2falcot1</code>, which clearly indicates the origin of the package. This makes the package version number higher than the one provided by Debian, so that the package will easily install as an update to the original package. Such a change is best effected with the <span class="command"><strong>dch</strong></span> command (<span class="emphasis"><em>Debian CHangelog</em></span>) from the <span class="pkg pkg">devscripts</span> package, with an command such as <span class="command"><strong>dch --local falcot</strong></span>. This invokes a text editor (<span class="command"><strong>sensible-editor</strong></span> — this should be your favorite editor if it is mentioned in the <code class="varname">VISUAL</code> or <code class="varname">EDITOR</code> environment variables, and the default editor otherwise) to allow documenting the differences brought by this rebuild. This editor shows us that <span class="command"><strong>dch</strong></span> really did change the <code class="filename">debian/changelog</code> file.
			</p>
			 <p>
				When a change in build options is required, the changes need to be made in <code class="filename">debian/rules</code>, which drives the steps in the package build process. In the simplest cases, the lines concerning the initial configuration (<code class="literal">./configure …</code>) or the actual build (<code class="literal">$(MAKE) …</code> or <code class="literal">make …</code>) are easy to spot. If these commands are not explicitly called, they are probably a side effect of another explicit command, in which case please refer to their documentation to learn more about how to change the default behavior. With packages using <span class="command"><strong>dh</strong></span>, you might need to add an override for the <span class="command"><strong>dh_auto_configure</strong></span> or <span class="command"><strong>dh_auto_build</strong></span> commands (see their respective manual pages for explanations on how to achieve this).
			</p>
			 <p>
				Depending on the local changes to the packages, an update may also be required in the <code class="filename">debian/control</code> file, which contains a description of the generated packages. In particular, this file contains <code class="literal">Build-Depends</code> lines controlling the list of dependencies that must be fulfilled at package build time. These often refer to versions of packages contained in the distribution the source package comes from, but which may not be available in the distribution used for the rebuild. There is no automated way to determine if a dependency is real or only specified to guarantee that the build should only be attempted with the latest version of a library — this is the only available way to force an <span class="emphasis"><em>autobuilder</em></span> to use a given package version during build, which is why Debian maintainers frequently use strictly versioned build-dependencies.
			</p>
			 <p>
				If you know for sure that these build-dependencies are too strict, you should feel free to relax them locally. Reading the files which document the standard way of building the software — these files are often called <code class="filename">INSTALL</code> — will help you figure out the appropriate dependencies. Ideally, all dependencies should be satisfiable from the distribution used for the rebuild; if they are not, a recursive process starts, whereby the packages mentioned in the <code class="literal">Build-Depends</code> field must be backported before the target package can be. Some packages may not need backporting, and can be installed as-is during the build process (a notable example is <span class="pkg pkg">debhelper</span>). Note that the backporting process can quickly become complex if you are not careful. Therefore, backports should be kept to a strict minimum when possible.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TIP</em></span> Installing <code class="literal">Build-Depends</code></strong></p></div></div></div> 
			 <a id="id-1.18.4.4.7.2" class="indexterm"></a>
			 <p>
				<span class="command"><strong>apt-get</strong></span> allows installing all packages mentioned in the <code class="literal">Build-Depends</code> fields of a source package available in a distribution mentioned in a <code class="literal">deb-src</code> line of the <code class="filename">/etc/apt/sources.list</code> file. This is a simple matter of running the <span class="command"><strong>apt-get build-dep <em class="replaceable">source-package</em></strong></span> command.
			</p>
			 </div>
		</section>
		 <section class="section" id="id-1.18.4.5"><div class="titlepage"><div><div><h3 class="title"><a xmlns="" id="id-1.18.4.5"/>15.1.3. Starting the Rebuild</h3></div></div></div>
			
			 <p>
				When all the needed changes have been applied to the sources, we can start generating the actual binary package (<code class="filename">.deb</code> file). The whole process is managed by the <span class="command"><strong>dpkg-buildpackage</strong></span> command.
			</p>
			 <div class="example" id="id-1.18.4.5.3"><a xmlns="" id="id-1.18.4.5.3"/><p class="title"><strong>Ví dụ 15.1. Rebuilding a package</strong></p><div class="example-contents">
				
				 
<pre class="screen"><code class="computeroutput">$ </code><strong class="userinput"><code>dpkg-buildpackage -us -uc </code></strong><code class="computeroutput">[...] </code></pre>

			</div></div>
			 <div class="sidebar" id="sidebar.fakeroot"><a xmlns="" id="sidebar.fakeroot"/><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>TOOL</em></span> <span class="command"><strong>fakeroot</strong></span></strong></p></div></div></div> 
			 <p>
				In essence, the package creation process is a simple matter of gathering in an archive a set of existing (or built) files; most of the files will end up being owned by <span class="emphasis"><em>root</em></span> in the archive. However, building the whole package under this user would imply increased risks; fortunately, this can be avoided with the <span class="command"><strong>fakeroot</strong></span> command. This tool can be used to run a program and give it the impression that it runs as <span class="emphasis"><em>root</em></span> and creates files with arbitrary ownership and permissions. When the program creates the archive that will become the Debian package, it is tricked into creating an archive containing files marked as belonging to arbitrary owners, including <span class="emphasis"><em>root</em></span>. This setup is so convenient that <span class="command"><strong>dpkg-buildpackage</strong></span> uses <span class="command"><strong>fakeroot</strong></span> by default when building packages.
			</p>
			 <p>
				Note that the program is only tricked into “believing” that it operates as a privileged account, and the process actually runs as the user running <span class="command"><strong>fakeroot <em class="replaceable">program</em></strong></span> (and the files are actually created with that user's permissions). At no time does it actually get root privileges that it could abuse.
			</p>
			 </div> <p>
				The previous command can fail if the <code class="literal">Build-Depends</code> fields have not been updated, or if the related packages are not installed. In such a case, it is possible to overrule this check by passing the <code class="literal">-d</code> option to <span class="command"><strong>dpkg-buildpackage</strong></span>. However, explicitly ignoring these dependencies runs the risk of the build process failing at a later stage. Worse, the package may seem to build correctly but fail to run properly: some programs automatically disable some of their features when a required library is not available at build time.
			</p>
			 <p>
				More often than not, Debian developers use a higher-level program such as <span class="command"><strong>debuild</strong></span>; this runs <span class="command"><strong>dpkg-buildpackage</strong></span> as usual, but it also adds an invocation of a program that runs many checks to validate the generated package against the Debian policy. This script also cleans up the environment so that local environment variables do not “pollute” the package build. The <span class="command"><strong>debuild</strong></span> command is one of the tools in the <span class="emphasis"><em>devscripts</em></span> suite, which share some consistency and configuration to make the maintainers' task easier.
			</p>
			 <div class="sidebar"><div class="titlepage"><div><div><p class="title"><strong><span class="emphasis"><em>QUICK LOOK</em></span> <span class="command"><strong>pbuilder</strong></span></strong></p></div></div></div> 
			 <a id="id-1.18.4.5.7.2" class="indexterm"></a>
			 <p>
				The <span class="command"><strong>pbuilder</strong></span> program (in the similarly named package) allows building a Debian package in a <span class="emphasis"><em>chrooted</em></span> environment. It first creates a temporary directory containing the minimal system required for building the package (including the packages mentioned in the <span class="emphasis"><em>Build-Depends</em></span> field). This directory is then used as the root directory (<code class="filename">/</code>), using the <span class="command"><strong>chroot</strong></span> command, during the build process.
			</p>
			 <p>
				This tool allows the build process to happen in an environment that is not altered by users' manipulations. This also allows for quick detection of the missing build-dependencies (since the build will fail unless the appropriate dependencies are documented). Finally, it allows building a package for a Debian version that is not the one used by the system as a whole: the machine can be using <span class="distribution distribution">Stable</span> for its normal workload, and a <span class="command"><strong>pbuilder</strong></span> running on the same machine can be using <span class="distribution distribution">Unstable</span> for package builds.
			</p>
			 </div>
		</section>

	</section>
	 
	 
	 
</section><footer/></body></html>